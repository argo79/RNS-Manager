<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RNS ‚Ä¢ monitor</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="/static/rns_monitor.css">
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>RETICULUM MONITOR 1.0.0</h1>
                <div class="header-subtitle">Monitoraggio annunci e identit√† Reticulum</div>
            </div>
            <div>
                <a href="/" class="back-button">‚Üê TORNA A IDENTITY MANAGER</a>
            </div>
        </header>

        <div style="margin: 20px 0; display: flex; gap: 20px; align-items: center;">
            <div class="stats">
                <span id="status" class="status offline"></span>
                <span id="total-announces">0</span> annunci ¬∑ <span id="unique-sources">0</span> identit√† uniche
            </div>
            <div style="flex:1;"></div>
            <div class="cache-controls" style="display: flex; gap: 10px; align-items: center;">
                <span style="color:var(--dim); font-size:11px;">üíæ cache:</span>
                <select id="cache-source-select" style="background:#1a1a1a; color:var(--fg); border:1px solid #333; padding:4px 8px; border-radius:4px;">
                    <option value="memory">üì± memoria (ultimi 1000)</option>
                    <option value="cache">üíæ disco (ultimi 7 giorni)</option>
                </select>
                <button class="btn" id="cache-clear-btn" style="background:#331100; color:#ffaa66; font-size:11px; padding:4px 8px;">pulisci cache</button>
                <button class="btn" id="cache-save-btn" style="background:#113311; color:#88ff88; font-size:11px; padding:4px 8px;">salva ora</button>
            </div>
        </div>

        <div class="tabs-main">
            <div class="tab-main active" data-view="live">üì° live</div>
            <div class="tab-main" data-view="identities">üÜî identit√†</div>
            <div class="tab-main" data-view="stats">üìä statistiche</div>
            <div class="tab-main" data-view="cache">üíæ cache storage</div>
        </div>

        <div id="view-live" class="view active">
            <div class="tabs-aspect-container" id="aspect-tabs-container">
                <div class="tabs-aspect-row" id="aspect-row-1"></div>
                <div class="tabs-aspect-row" id="aspect-row-2"></div>
                <div class="tabs-aspect-row" id="aspect-row-3"></div>
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label>ordina</label>
                    <select id="sort-select">
                        <option value="time_desc">‚è± pi√π recente</option>
                        <option value="time_asc">‚è± meno recente</option>
                        <option value="hops_asc">üì∂ hops ‚Üë</option>
                        <option value="hops_desc">üì∂ hops ‚Üì</option>
                        <option value="aspect_asc">üè∑ aspect a‚Üíz</option>
                        <option value="aspect_desc">üè∑ aspect z‚Üía</option>
                        <option value="identity_asc">üÜî identit√† a‚Üíz</option>
                        <option value="identity_desc">üÜî identit√† z‚Üía</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>mostra</label>
                    <select id="limit-select">
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>cerca</label>
                    <input type="text" id="search-input" placeholder="hash/aspect/dati" style="width: 180px;">
                    <button class="clear-search-btn" onclick="clearSearch()" title="Pulisci ricerca">‚úï</button>
                </div>
                <div style="flex:1; text-align:right; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn" id="clear-btn" style="background:#330000; color:#ff6666;">pulisci storico</button>
                    <button class="btn" id="clear-all-btn" style="background:#550000; color:#ffaa00;">üîÑ reset completo</button>
                </div>
            </div>

            <table class="table" id="announce-table">
                <thead>
                    <tr>
                        <th style="width:8%" data-sort="time">‚è± tempo</th>
                        <th style="width:20%" data-sort="identity">üÜî identit√†</th>
                        <th style="width:20%" data-sort="dest">üéØ destinazione</th>
                        <th style="width:17%" data-sort="aspect">üè∑ aspect</th>
                        <th style="width:5%" data-sort="hops">üì∂ hops</th>
                        <th style="width:10%" data-sort="iface">üåê iface</th>
                        <th style="width:20%" data-sort="data">üí¨ dati</th>
                    </tr>
                </thead>
                <tbody id="announce-body">
                    <tr><td colspan="7" style="text-align:center; padding:40px; color:var(--dim);">‚è≥ in attesa di annunci...</td></tr>
                </tbody>
            </table>

            <div class="pagination">
                <div><span id="showing-start">0</span>-<span id="showing-end">0</span> di <span id="total-items">0</span></div>
                <div style="display:flex; gap:8px;">
                    <button class="btn" id="prev-page">‚Üê</button>
                    <span id="page-info" style="padding:4px 0;">pagina 1</span>
                    <button class="btn" id="next-page">‚Üí</button>
                </div>
            </div>
        </div>

        <div id="view-identities" class="view">
            <div class="identity-sort-bar">
                <div class="sort-controls">
                    <span style="color:var(--dim);">ordina per:</span>
                    <select id="identity-sort-select" class="sort-select">
                        <option value="count_desc">üìä annunci (‚Üì)</option>
                        <option value="count_asc">üìä annunci (‚Üë)</option>
                        <option value="rate_desc">‚ö° frequenza (‚Üì)</option>
                        <option value="rate_asc">‚ö° frequenza (‚Üë)</option>
                        <option value="period_asc">‚è±Ô∏è periodo (‚Üë)</option>
                        <option value="period_desc">‚è±Ô∏è periodo (‚Üì)</option>
                        <option value="aspects_desc">üè∑ aspect (‚Üì)</option>
                        <option value="aspects_asc">üè∑ aspect (‚Üë)</option>
                        <option value="last_desc">‚è± ultimo (‚Üì)</option>
                        <option value="last_asc">‚è± ultimo (‚Üë)</option>
                        <option value="hash_asc">üîë hash (A‚ÜíZ)</option>
                        <option value="hash_desc">üîë hash (Z‚ÜíA)</option>
                    </select>
                </div>
                <div class="search-identity" style="display: flex; gap: 5px;">
                    <input type="text" id="identity-search-input" class="identity-search-input" placeholder="üîç cerca identit√†...">
                    <button class="clear-search-btn" onclick="clearIdentitySearch()" title="Pulisci ricerca">‚úï</button>
                </div>
                <span style="flex:1; text-align:right; color:var(--dim);" id="identity-count">0 identit√†</span>
            </div>
            <div id="identity-container"></div>
        </div>

        <div id="view-stats" class="view">
            <div class="grid-2">
                <div class="stat-card">
                    <div class="stat-number" id="stat-total">0</div>
                    <div class="stat-label">annunci totali</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-identities">0</div>
                    <div class="stat-label">identit√†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-rate">0</div>
                    <div class="stat-label">frequenza media</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-period">0</div>
                    <div class="stat-label">periodo medio</div>
                </div>
            </div>
            
            <h3 style="font-size:12px; margin:20px 0 10px; font-weight:normal; color:var(--dim);">top aspect</h3>
            <div id="stats-aspects" class="grid-2" style="grid-template-columns:repeat(auto-fill, minmax(180px,1fr));"></div>
            
            <h3 style="font-size:12px; margin:20px 0 10px; font-weight:normal; color:var(--dim);">top identit√†</h3>
            <div id="stats-identities" class="grid-2" style="grid-template-columns:repeat(auto-fill, minmax(300px,1fr));"></div>
        </div>

        <div id="view-cache" class="view">
            <h2 style="font-size:16px; margin-bottom:20px;">üíæ Cache Storage</h2>
            
            <div class="grid-2" style="margin-bottom:30px;">
                <div class="stat-card" id="cache-size-card">
                    <div class="stat-number" id="cache-size">0</div>
                    <div class="stat-label">annunci in cache</div>
                </div>
                <div class="stat-card" id="cache-age-card">
                    <div class="stat-number" id="cache-age">0</div>
                    <div class="stat-label">giorni di storico</div>
                </div>
                <div class="stat-card" id="cache-saves-card">
                    <div class="stat-number" id="cache-saves">0</div>
                    <div class="stat-label">salvataggi</div>
                </div>
                <div class="stat-card" id="cache-file-card">
                    <div class="stat-number" id="cache-file">-</div>
                    <div class="stat-label">file cache</div>
                </div>
            </div>

            <h3 style="font-size:12px; margin:20px 0 10px; font-weight:normal; color:var(--dim);">distribuzione aspect in cache</h3>
            <div id="cache-aspects" class="grid-2" style="grid-template-columns:repeat(auto-fill, minmax(180px,1fr)); margin-bottom:30px;"></div>

            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn" id="cache-refresh-stats" style="background:#1a1a1a;">‚ü≥ aggiorna statistiche</button>
                <button class="btn" id="cache-cleanup-old" style="background:#331100; color:#ffaa66;">üßπ pulizia vecchi (>7gg)</button>
                <button class="btn" id="cache-export" style="background:#113311; color:#88ff88;">üì§ esporta cache</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // === CONFIGURAZIONE ===
        // ============================================
        
        const STORAGE_KEY = 'rns_monitor_identities';
        const INACTIVE_TIMEOUT = 3600;
        
        const ASPECTS = [
            "lxmf.delivery","nomadnetwork.node","lxst.telephony","call.audio","retibbs.bbs","rrc.hub","lxmf.propagation",
            "rnstransport.probe","rnstransport.info.blackhole","rnsh.listen","rnsh.default","rnsh","rncp","rncp.receive",
            "rns_unit_tests.link.establish",
            "rnstransport.discovery.interface",
            "rnstransport.tunnel.synthesize",
            "rnstransport.path.request",
            "rnstransport.remote.management",    
            "rnstransport.network.instance",
            "rnstransport.network",
            "example_utilities.minimalsample",
            "example_utilities.execute",
            "example_utilities.echo.request",
            "example_utilities.broadcast",
            "example_utilities.bufferexample",
            "example_utilities.channelexample",
            "example_utilities.filetransfer.server",
            "example_utilities.identifyexample",
            "example_utilities.linkexample",
            "example_utilities.ratchet.echo.request",
            "example_utilities.requestexample",
            "example_utilities.resourceexample",
            "example_utilities.speedtest","discovery.interface",
        ];

        const state = {
            view: 'live',
            aspect: 'all',
            page: 1,
            limit: 100,
            sort: 'time_desc',
            search: '',
            identitySearch: '',
            lastId: 0,
            identities: new Map(),
            expandedIdentities: new Set(),
            identitySort: 'count_desc',
            cacheSource: 'memory',
            resetting: false
        };

        // ============================================
        // === MODAL STATE ===
        // ============================================
        
        const modalState = {
            visible: false,
            identityHash: '',
            aspectHash: '',
            aspect: '',
            identityPath: null
        };

        // ============================================
        // === FUNZIONI DI UTILIT√Ä ===
        // ============================================

        function clearSearch() {
            document.getElementById('search-input').value = '';
            state.search = '';
            state.page = 1;
            loadHistory();
        }

        function clearIdentitySearch() {
            document.getElementById('identity-search-input').value = '';
            state.identitySearch = '';
            renderIdentities();
        }

        function showIdentityInTab(identityHash) {
            document.querySelectorAll('.tab-main').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-view="identities"]').classList.add('active');
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-identities').classList.add('active');
            state.view = 'identities';
            
            document.getElementById('identity-search-input').value = identityHash;
            state.identitySearch = identityHash;
            
            renderIdentities();
            
            setTimeout(() => {
                const identityGroups = document.querySelectorAll('.identity-group');
                identityGroups.forEach(group => {
                    const header = group.querySelector('.identity-header');
                    const hashSpan = group.querySelector('.identity-hash');
                    if (hashSpan && hashSpan.textContent.includes(identityHash.slice(0, 32))) {
                        if (!header.classList.contains('expanded')) {
                            header.click();
                        }
                        group.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }, 500);
        }

        function hideAspectModal() {
            const modal = document.getElementById('aspect-modal');
            if (modal) {
                modal.classList.remove('visible');
                modalState.visible = false;
            }
        }

        function executeRnsCommand(command, destination, aspect = null) {
            const outputDiv = document.getElementById('modal-output');
            if (!outputDiv) {
                console.error('outputDiv non trovato');
                return;
            }
            
            outputDiv.innerHTML = '‚è≥ Esecuzione in corso...';
            outputDiv.style.color = '#88ff88';
            
            console.log(`[DEBUG] Eseguo ${command} per:`, destination);
            
            if (command === 'path') {
                const url = `/api/rns/paths?dest=${encodeURIComponent(destination)}`;
                console.log('[DEBUG] Fetch URL:', url);
                
                fetch(url)
                    .then(response => {
                        console.log('[DEBUG] Response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('[DEBUG] Response data:', data);
                        
                        if (data.success) {
                            let output = data.output || '';
                            
                            // Cerca la linea che contiene "Path found"
                            const lines = output.split('\n');
                            let cleanOutput = '';
                            
                            for (let i = lines.length - 1; i >= 0; i--) {
                                const line = lines[i];
                                if (line.includes('Path found')) {
                                    cleanOutput = line;
                                    break;
                                }
                            }
                            
                            if (cleanOutput) {
                                // Pulisci dai caratteri di controllo
                                cleanOutput = cleanOutput
                                    .replace(/.\u0008/g, '')  // Rimuovi backspace + carattere
                                    .replace(/[\u2800-\u28FF]/g, '')  // Rimuovi caratteri Braille
                                    .replace(/\s+/g, ' ')  // Normalizza spazi
                                    .trim();
                                
                                // ESCAPE DEI CARATTERI HTML PER VISUALIZZARE CORRETTAMENTE <>
                                cleanOutput = cleanOutput
                                    .replace(/&/g, '&amp;')
                                    .replace(/</g, '&lt;')
                                    .replace(/>/g, '&gt;')
                                    .replace(/"/g, '&quot;')
                                    .replace(/'/g, '&#039;');
                                
                                outputDiv.innerHTML = cleanOutput;
                            } else {
                                // Se non trovi "Path found", mostra tutto l'output
                                output = output
                                    .replace(/.\u0008/g, '')
                                    .replace(/[\u2800-\u28FF]/g, '')
                                    .replace(/\s+/g, ' ')
                                    .trim()
                                    .replace(/&/g, '&amp;')
                                    .replace(/</g, '&lt;')
                                    .replace(/>/g, '&gt;')
                                    .replace(/"/g, '&quot;')
                                    .replace(/'/g, '&#039;');
                                
                                outputDiv.innerHTML = output || '‚úÖ Comando eseguito (nessun output)';
                            }
                        } else {
                            outputDiv.innerHTML = `‚ùå Errore: ${data.error || 'Comando fallito'}`;
                            outputDiv.style.color = '#ff6666';
                        }
                    })
                    .catch(err => {
                        console.error('[DEBUG] Fetch error:', err);
                        outputDiv.innerHTML = `‚ùå Errore di connessione: ${err.message}`;
                        outputDiv.style.color = '#ff6666';
                    });
                    
            } else if (command === 'probe') {
                fetch('/api/rns/probe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        destination: destination, 
                        aspect: aspect || 'rnstransport.probe'
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('[DEBUG] Probe response:', data);
                        
                        if (data.success) {
                            let output = data.output || '';
                            
                            // Pulisci l'output
                            output = output
                                .replace(/.\u0008/g, '')  // backspace
                                .replace(/[\u2800-\u28FF]/g, '')  // caratteri braille
                                .split('\n')
                                .filter(line => line.trim() && !line.includes('Sent probe'))
                                .join('\n')
                                .trim();
                            
                            // Escape HTML
                            output = output
                                .replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/"/g, '&quot;')
                                .replace(/'/g, '&#039;');
                            
                            outputDiv.innerHTML = output || '‚úÖ Probe inviato (nessuna risposta)';
                        } else {
                            outputDiv.innerHTML = `‚ùå Errore probe: ${data.error || 'Fallito'}`;
                            outputDiv.style.color = '#ff6666';
                        }
                    })
                    .catch(err => {
                        console.error('[DEBUG] Probe error:', err);
                        outputDiv.innerHTML = `‚ùå Errore: ${err.message}`;
                        outputDiv.style.color = '#ff6666';
                    });
            } else if (command === 'blackhole') {
                // destination qui √® l'identityHash, non l'aspect hash
                fetch('/api/rns/paths/blackhole', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ destination: destination })  // destination = identityHash
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            let output = data.output || '';
                            output = output
                                .replace(/.\u0008/g, '')
                                .replace(/[\u2800-\u28FF]/g, '')
                                .split('\n')
                                .filter(line => line.trim())
                                .join('\n')
                                .trim()
                                .replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;');
                            
                            outputDiv.innerHTML = output || '‚úÖ Nessun blackhole trovato per questa identit√†';
                        } else {
                            outputDiv.innerHTML = `‚ùå Errore: ${data.error}`;
                        }
                    })
                    .catch(err => {
                        outputDiv.innerHTML = `‚ùå Errore: ${err.message}`;
                    });
            }
        }

        function showAspectModal(identityHash, aspect, destHash) {
            modalState.identityHash = identityHash;
            modalState.aspect = aspect;
            modalState.aspectHash = destHash;
            
            fetch(`/api/identities/find/by-hash?hash=${identityHash}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        modalState.identityPath = data.identity_path;
                    }
                })
                .catch(err => console.error('Errore ricerca identit√†:', err));
            
            let modal = document.getElementById('aspect-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'aspect-modal';
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="hideAspectModal()"></div>
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>üè∑ Dettagli Aspect</h3>
                            <button class="modal-close" onclick="hideAspectModal()">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <div class="modal-info">
                                <div class="info-row">
                                    <span class="info-label">Identit√†:</span>
                                    <span class="info-value identity-hash" id="modal-identity-hash"></span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Aspect:</span>
                                    <span class="info-value" id="modal-aspect"></span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Hash Aspect:</span>
                                    <span class="info-value monospace" id="modal-aspect-hash"></span>
                                </div>
                            </div>
                            <div class="modal-actions" id="modal-actions"></div>
                            <div class="modal-output" id="modal-output"></div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('modal-identity-hash').textContent = identityHash;
            document.getElementById('modal-identity-hash').onclick = () => {
                hideAspectModal();
                showIdentityInTab(identityHash);
            };
            document.getElementById('modal-aspect').textContent = aspect;
            document.getElementById('modal-aspect-hash').textContent = destHash;
            
            const actionsDiv = document.getElementById('modal-actions');
            actionsDiv.innerHTML = '';
            
            const pathBtn = document.createElement('button');
            pathBtn.className = 'modal-btn';
            pathBtn.innerHTML = 'üõ£Ô∏è rnpath';
            pathBtn.onclick = () => executeRnsCommand('path', destHash);
            actionsDiv.appendChild(pathBtn);
            
            if (aspect === 'rnstransport.probe') {
                const probeBtn = document.createElement('button');
                probeBtn.className = 'modal-btn probe';
                probeBtn.innerHTML = 'üì° rnprobe';
                probeBtn.onclick = () => executeRnsCommand('probe', destHash, aspect);
                actionsDiv.appendChild(probeBtn);
            }
            
            // Per rnstransport.info.blackhole - comando speciale rnpath -p
            if (aspect === 'rnstransport.info.blackhole') {
                const blackholeBtn = document.createElement('button');
                blackholeBtn.className = 'modal-btn blackhole';
                blackholeBtn.innerHTML = 'üï≥Ô∏è rnpath -p (blackhole)';
                // Usa identityHash invece di destHash!
                blackholeBtn.onclick = () => executeRnsCommand('blackhole', modalState.identityHash);
                actionsDiv.appendChild(blackholeBtn);
            }

            modal.classList.add('visible');
            modalState.visible = true;
        }

        function saveIdentitiesToStorage() {
            try {
                const identitiesArray = [];
                state.identities.forEach((value, key) => {
                    identitiesArray.push({
                        hash: key,
                        first: value.first,
                        last: value.last,
                        count: value.count,
                        lastData: value.lastData,
                        aspects: Array.from(value.aspects.entries()).map(([asp, data]) => ({
                            aspect: asp,
                            dest: data.dest,
                            count: data.count,
                            last: data.last,
                            data: data.data
                        }))
                    });
                });
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    timestamp: Date.now(),
                    identities: identitiesArray
                }));
            } catch(e) {
                console.warn('Errore salvataggio:', e);
            }
        }

        function loadIdentitiesFromStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) return false;
                
                const data = JSON.parse(stored);
                const age = (Date.now() - data.timestamp) / 1000;
                
                if (age > 3600) {
                    localStorage.removeItem(STORAGE_KEY);
                    return false;
                }
                
                state.identities.clear();
                data.identities.forEach(item => {
                    const aspects = new Map();
                    item.aspects.forEach(asp => {
                        aspects.set(asp.aspect, {
                            dest: asp.dest,
                            count: asp.count,
                            last: asp.last,
                            data: asp.data
                        });
                    });
                    
                    state.identities.set(item.hash, {
                        hash: item.hash,
                        first: item.first,
                        last: item.last,
                        count: item.count,
                        lastData: item.lastData,
                        aspects: aspects
                    });
                });
                
                return true;
            } catch(e) {
                console.warn('Errore caricamento:', e);
                return false;
            }
        }

        function decodeUTF8(str) {
            if (!str) return '';
            try {
                return decodeURIComponent(escape(str));
            } catch(e) {
                return str;
            }
        }

        function formatRate(rateHz) {
            if (rateHz >= 1) {
                return rateHz.toFixed(2) + ' Hz';
            } else if (rateHz >= 0.001) {
                return (rateHz * 1000).toFixed(1) + ' mHz';
            } else if (rateHz > 0) {
                return (rateHz * 1000000).toFixed(0) + ' ¬µHz';
            } else {
                return '‚Äî';
            }
        }

        function formatPeriod(periodSeconds) {
            if (periodSeconds >= 3600) {
                return (periodSeconds / 3600).toFixed(1) + ' h';
            } else if (periodSeconds >= 60) {
                return (periodSeconds / 60).toFixed(1) + ' min';
            } else if (periodSeconds >= 1) {
                return periodSeconds.toFixed(1) + ' s';
            } else if (periodSeconds > 0) {
                return (periodSeconds * 1000).toFixed(0) + ' ms';
            } else {
                return '‚Äî';
            }
        }

        function isActive(timestamp) {
            const now = Date.now() / 1000;
            return (now - timestamp) < INACTIVE_TIMEOUT;
        }

        function getAspectCounts() {
            const counts = new Map();
            counts.set('all', 0);
            counts.set('known', 0);
            counts.set('unknown', 0);
            
            ASPECTS.forEach(a => counts.set(a, 0));
            
            state.identities.forEach(id => {
                id.aspects.forEach((data, asp) => {
                    if (ASPECTS.includes(asp)) {
                        counts.set(asp, (counts.get(asp) || 0) + data.count);
                        counts.set('known', counts.get('known') + data.count);
                        counts.set('all', counts.get('all') + data.count);
                    }
                });
            });
            
            let unknownCount = 0;
            state.identities.forEach(id => {
                id.aspects.forEach((data, asp) => {
                    if (!ASPECTS.includes(asp) && asp !== 'identity_hash') {
                        unknownCount += data.count;
                        counts.set('all', counts.get('all') + data.count);
                    }
                });
            });
            counts.set('unknown', unknownCount);
            
            return counts;
        }

        function initAspectTabs() {
            const row1 = document.getElementById('aspect-row-1');
            const row2 = document.getElementById('aspect-row-2');
            const row3 = document.getElementById('aspect-row-3');
            
            function renderAspectTabs() {
                const counts = getAspectCounts();
                
                let html1 = `<div class="tab-aspect ${state.aspect === 'all' ? 'active' : ''}" data-aspect="all">üìã tutti (${counts.get('all') || 0})</div>`;
                ASPECTS.slice(0, 10).forEach(a => {
                    const short = a.split('.').pop();
                    const count = counts.get(a) || 0;
                    html1 += `<div class="tab-aspect ${state.aspect === a ? 'active' : ''}" data-aspect="${a}">${short} (${count})</div>`;
                });
                row1.innerHTML = html1;
                
                let html2 = ``;
                ASPECTS.slice(10, 20).forEach(a => {
                    const short = a.split('.').pop();
                    const count = counts.get(a) || 0;
                    html2 += `<div class="tab-aspect ${state.aspect === a ? 'active' : ''}" data-aspect="${a}">${short} (${count})</div>`;
                });
                row2.innerHTML = html2;
                
                let html3 = ``;
                ASPECTS.slice(20).forEach(a => {
                    const short = a.split('.').pop();
                    const count = counts.get(a) || 0;
                    html3 += `<div class="tab-aspect ${state.aspect === a ? 'active' : ''}" data-aspect="${a}">${short} (${count})</div>`;
                });
                html3 += `<div class="tab-aspect ${state.aspect === 'known' ? 'active' : ''}" data-aspect="known">‚úì conosciuti (${counts.get('known') || 0})</div>`;
                html3 += `<div class="tab-aspect ${state.aspect === 'unknown' ? 'active' : ''}" data-aspect="unknown">? sconosciuti (${counts.get('unknown') || 0})</div>`;
                row3.innerHTML = html3;
                
                document.querySelectorAll('.tab-aspect').forEach(tab => {
                    tab.addEventListener('click', function(e) {
                        document.querySelectorAll('.tab-aspect').forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        state.aspect = this.dataset.aspect;
                        state.page = 1;
                        loadHistory();
                    });
                });
            }
            
            renderAspectTabs();
            window.updateAspectTabs = renderAspectTabs;
        }

        function initMainTabs() {
            document.querySelectorAll('.tab-main').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab-main').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                    document.getElementById(`view-${this.dataset.view}`).classList.add('active');
                    state.view = this.dataset.view;
                    
                    if (state.view === 'identities') {
                        renderIdentities();
                    }
                    if (state.view === 'stats') {
                        renderStats();
                    }
                    if (state.view === 'cache') {
                        loadCacheStats();
                    }
                });
            });
        }

        function createAnnounceRow(a) {
            const idShort = a.identity_hash?.slice(0, 32) || '?';
            const destShort = a.dest_hash?.slice(0, 32) || '-';
            const decodedData = decodeUTF8(a.data || '');
            
            let row = '<tr>';
            row += `<td style="white-space:nowrap; color:var(--dim);">${a.time || ''}</td>`;
            
            row += `<td class="identity" title="${a.identity_hash || ''}">`;
            row += `<span class="clickable-hash" onclick="showIdentityInTab('${a.identity_hash}')">${idShort}</span>`;
            row += `</td>`;
            
            row += `<td class="dest" title="${a.dest_hash || ''}">`;
            row += `<span class="clickable-hash" onclick="showAspectModal('${a.identity_hash}', '${a.aspect || 'unknown'}', '${a.dest_hash}')">${destShort}</span>`;
            row += `</td>`;
            
            if (a.aspect && a.aspect !== 'unknown' && a.aspect !== 'identity_hash') {
                row += `<td><span class="badge">${a.aspect}</span></td>`;
            } else {
                row += `<td><span class="unknown">sconosciuto</span></td>`;
            }
            
            row += `<td style="text-align:center;"><span class="badge-hops">${a.hops || '?'}</span></td>`;
            row += `<td class="iface">${a.interface?.split('[')[0] || '?'}</td>`;
            row += `<td class="data" style="font-family: monospace;">${decodedData || ''}</td>`;
            row += '</tr>';
            
            return row;
        }

        function renderTable(announces) {
            const tbody = document.getElementById('announce-body');
            if (!announces?.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:var(--dim);">‚Äî nessun annuncio ‚Äî</td></tr>';
                return;
            }

            let html = '';
            announces.forEach(a => {
                html += createAnnounceRow(a);
            });
            tbody.innerHTML = html;
        }

        function sortTableRows(rows, sortType) {
            const rowsArray = Array.from(rows);
            
            return rowsArray.sort((a, b) => {
                const cellsA = a.querySelectorAll('td');
                const cellsB = b.querySelectorAll('td');
                
                try {
                    switch(sortType) {
                        case 'time_desc': {
                            const timeA = cellsA[0]?.textContent || '';
                            const timeB = cellsB[0]?.textContent || '';
                            return timeB.localeCompare(timeA);
                        }
                        case 'time_asc': {
                            const timeA = cellsA[0]?.textContent || '';
                            const timeB = cellsB[0]?.textContent || '';
                            return timeA.localeCompare(timeB);
                        }
                        case 'hops_asc': {
                            const hopsA = parseInt(cellsA[4]?.textContent) || 999;
                            const hopsB = parseInt(cellsB[4]?.textContent) || 999;
                            return hopsA - hopsB;
                        }
                        case 'hops_desc': {
                            const hopsA = parseInt(cellsA[4]?.textContent) || 0;
                            const hopsB = parseInt(cellsB[4]?.textContent) || 0;
                            return hopsB - hopsA;
                        }
                        case 'aspect_asc': {
                            const aspectA = cellsA[3]?.textContent?.replace(/[‚ö°üì∂üè∑üîëüìã]/g, '').trim() || '';
                            const aspectB = cellsB[3]?.textContent?.replace(/[‚ö°üì∂üè∑üîëüìã]/g, '').trim() || '';
                            return aspectA.localeCompare(aspectB);
                        }
                        case 'aspect_desc': {
                            const aspectA = cellsA[3]?.textContent?.replace(/[‚ö°üì∂üè∑üîëüìã]/g, '').trim() || '';
                            const aspectB = cellsB[3]?.textContent?.replace(/[‚ö°üì∂üè∑üîëüìã]/g, '').trim() || '';
                            return aspectB.localeCompare(aspectA);
                        }
                        case 'identity_asc': {
                            const idA = cellsA[1]?.textContent || '';
                            const idB = cellsB[1]?.textContent || '';
                            return idA.localeCompare(idB);
                        }
                        case 'identity_desc': {
                            const idA = cellsA[1]?.textContent || '';
                            const idB = cellsB[1]?.textContent || '';
                            return idB.localeCompare(idA);
                        }
                        default:
                            return 0;
                    }
                } catch(e) {
                    console.error('Errore ordinamento:', e);
                    return 0;
                }
            });
        }

        function resortLiveTable() {
            if (state.view !== 'live') return;
            
            const tbody = document.getElementById('announce-body');
            const rows = tbody.querySelectorAll('tr');
            
            if (rows.length && !rows[0].innerHTML.includes('nessun annuncio')) {
                const sortedRows = sortTableRows(rows, state.sort);
                tbody.innerHTML = '';
                sortedRows.forEach(r => tbody.appendChild(r));
            }
        }

        function updateIdentityStats(ann) {
            // IGNORA DURANTE IL RESET
            if (state.resetting) return;
            
            if (!ann.identity_hash) return;
            const id = ann.identity_hash.slice(0, 32);
            
            if (!state.identities.has(id)) {
                state.identities.set(id, {
                    hash: id,
                    first: ann.timestamp,
                    last: ann.timestamp,
                    count: 0,
                    aspects: new Map(),
                    lastData: ann.data
                });
            }
            
            const ident = state.identities.get(id);
            ident.last = Math.max(ident.last, ann.timestamp);
            ident.first = Math.min(ident.first, ann.timestamp);
            ident.count++;
            if (ann.data) ident.lastData = ann.data;
            
            const aspect = ann.aspect || 'unknown';
            if (!ident.aspects.has(aspect)) {
                ident.aspects.set(aspect, {
                    dest: ann.dest_hash,
                    count: 0,
                    last: ann.timestamp,
                    data: ann.data
                });
            }
            const asp = ident.aspects.get(aspect);
            asp.count++;
            asp.last = ann.timestamp;
            if (ann.data) asp.data = ann.data;
            
            saveIdentitiesToStorage();
            if (window.updateAspectTabs) window.updateAspectTabs();
        }

        function identityPassesSearch(identity, searchTerm) {
            if (!searchTerm) return true;
            
            const term = searchTerm.toLowerCase();
            
            if (identity.hash.toLowerCase().includes(term)) return true;
            
            if (identity.lastData && identity.lastData.toLowerCase().includes(term)) return true;
            
            for (let [asp, data] of identity.aspects) {
                if (asp.toLowerCase().includes(term)) return true;
                if (data.dest && data.dest.toLowerCase().includes(term)) return true;
                if (data.data && data.data.toLowerCase().includes(term)) return true;
            }
            
            return false;
        }

        function getIdentitySortFunction() {
            const sortValue = document.getElementById('identity-sort-select')?.value || 'count_desc';
            
            let [field, direction] = sortValue.split('_');
            const dir = direction === 'desc' ? -1 : 1;
            
            return (a, b) => {
                try {
                    switch(field) {
                        case 'count':
                            return dir * (b.count - a.count);
                        case 'rate': {
                            const aActive = isActive(a.last);
                            const bActive = isActive(b.last);
                            if (!aActive && !bActive) return 0;
                            if (!aActive) return 1;
                            if (!bActive) return -1;
                            const rateA = a.count / ((a.last - a.first) || 1);
                            const rateB = b.count / ((b.last - b.first) || 1);
                            return dir * (rateB - rateA);
                        }
                        case 'period': {
                            const aActive = isActive(a.last);
                            const bActive = isActive(b.last);
                            if (!aActive && !bActive) return 0;
                            if (!aActive) return 1;
                            if (!bActive) return -1;
                            const rateA = a.count / ((a.last - a.first) || 1);
                            const rateB = b.count / ((b.last - b.first) || 1);
                            const periodA = rateA > 0 ? 1 / rateA : Infinity;
                            const periodB = rateB > 0 ? 1 / rateB : Infinity;
                            return dir * (periodA - periodB);
                        }
                        case 'aspects':
                            return dir * (b.aspects.size - a.aspects.size);
                        case 'last':
                            return dir * (b.last - a.last);
                        case 'hash':
                            return dir * a.hash.localeCompare(b.hash);
                        default:
                            return dir * (b.count - a.count);
                    }
                } catch(e) {
                    console.error('Errore ordinamento identit√†:', e);
                    return 0;
                }
            };
        }

        function toggleIdentity(identityHash, element) {
            if (state.expandedIdentities.has(identityHash)) {
                state.expandedIdentities.delete(identityHash);
                element.classList.remove('expanded');
                element.nextElementSibling.classList.remove('expanded');
            } else {
                state.expandedIdentities.add(identityHash);
                element.classList.add('expanded');
                element.nextElementSibling.classList.add('expanded');
            }
        }

        function renderIdentities() {
            const container = document.getElementById('identity-container');
            let html = '';
            
            const searchTerm = document.getElementById('identity-search-input')?.value || '';
            state.identitySearch = searchTerm;
            
            let filteredIdentities = [...state.identities.values()];
            if (searchTerm) {
                filteredIdentities = filteredIdentities.filter(id => identityPassesSearch(id, searchTerm));
            }
            
            const sorted = filteredIdentities.sort(getIdentitySortFunction());
            document.getElementById('identity-count').textContent = `${sorted.length} identit√†${searchTerm ? ` (filtrate)` : ''}`;
            
            sorted.slice(0, 100).forEach(id => {
                const now = Date.now() / 1000;
                const active = isActive(id.last);
                const elapsedSeconds = id.last - id.first;
                
                let rateHz = 0;
                let rateFormatted = '‚Äî';
                let periodFormatted = '‚Äî';
                let periodSeconds = 0;
                
                if (elapsedSeconds > 0 && id.count > 1 && active) {
                    rateHz = id.count / elapsedSeconds;
                    rateFormatted = formatRate(rateHz);
                    periodSeconds = 1 / rateHz;
                    periodFormatted = formatPeriod(periodSeconds);
                } else if (!active && id.count > 0) {
                    rateFormatted = 'üí§ inattivo';
                    periodFormatted = '‚Äî';
                }
                
                const isExpanded = state.expandedIdentities.has(id.hash);
                const lastData = decodeUTF8(id.lastData);
                const lastActiveAgo = Math.round((now - id.last) / 60);
                
                html += `<div class="identity-group" data-identity-hash="${id.hash}">`;
                html += `<div class="identity-header ${isExpanded ? 'expanded' : ''}" onclick="toggleIdentity('${id.hash}', this)">`;
                html += `<div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">`;
                html += `<span class="identity-hash" title="${id.hash}"> ${id.hash.slice(0,32)} </span>`;
                html += `<span style="color:var(--fg);"> ${id.count} annunci</span>`;
                
                if (active) {
                    html += `<span style="color:#ffff88; font-size:10px;" title="frequenza: ${rateFormatted}">‚ö° ${rateFormatted}</span>`;
                    html += `<span style="color:#88ffff; font-size:10px;" title="periodo: ogni ${periodFormatted}">‚è±Ô∏è ${periodFormatted}</span>`;
                } else {
                    html += `<span class="inactive" style="font-size:10px;">üí§ ${lastActiveAgo} min fa</span>`;
                }
                
                if (lastData) {
                    const cleanData = lastData.replace(/[\x00-\x1F\x7F-\x9F]/g, '');
                    html += `<span class="app-data-preview" title="${cleanData}">üìã ${cleanData.slice(0,40)}${cleanData.length > 64 ? '‚Ä¶' : ''}</span>`;
                }
                html += `</div>`;
                html += `<span style="color:var(--dim);">${id.aspects.size} aspect</span>`;
                html += `</div>`;
                html += `<div class="aspect-list ${isExpanded ? 'expanded' : ''}">`;
                
                const aspects = [...id.aspects.entries()].sort((a,b) => b[1].count - a[1].count);
                aspects.forEach(([asp, data]) => {
                    const aspActive = isActive(data.last);
                    let aspRateHz = 0;
                    let aspRateFormatted = '‚Äî';
                    let aspPeriodFormatted = '‚Äî';
                    
                    if (elapsedSeconds > 0 && data.count > 1 && aspActive) {
                        aspRateHz = data.count / elapsedSeconds;
                        aspRateFormatted = formatRate(aspRateHz);
                        const aspPeriodSeconds = 1 / aspRateHz;
                        aspPeriodFormatted = formatPeriod(aspPeriodSeconds);
                    }
                    
                    const destShort = data.dest ? `${data.dest.slice(0,32)} ` : '-';
                    const aspData = decodeUTF8(data.data);
                    
                    html += `<div class="aspect-item">`;
                    html += `<div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">`;
                    html += `<span class="badge" style="background:#0a1a0a;">${asp}</span>`;
                    html += `<span class="aspect-dest" title="${data.dest}">`;
                    html += `<span class="clickable-hash" onclick="showAspectModal('${id.hash}', '${asp}', '${data.dest}')">${destShort}</span>`;
                    html += `</span>`;
                    if (aspData) {
                        const cleanAspData = aspData.replace(/[\x00-\x1F\x7F-\x9F]/g, '');
                        html += `<span style="color:#88ff88; font-size:10px;">üìã ${cleanAspData.slice(0,25)}${cleanAspData.length > 64 ? '‚Ä¶' : ''}</span>`;
                    }
                    html += `</div>`;
                    html += `<div style="display: flex; gap: 10px;">`;
                    html += `<span style="color:var(--fg);">${data.count} ann.</span>`;
                    html += `<span class="rate" title="frequenza">${aspRateFormatted}</span>`;
                    html += `<span class="period" title="periodo">${aspPeriodFormatted}</span>`;
                    html += `</div>`;
                    html += `</div>`;
                });
                
                html += `</div></div>`;
            });
            
            container.innerHTML = html || '<div style="color:var(--dim); text-align:center; padding:40px;">nessuna identit√†</div>';
        }

        function renderStats() {
            const now = Date.now() / 1000;
            let totalAnnounces = 0;
            let firstSeen = now;
            let lastSeen = 0;
            let activeIdentities = 0;
            
            state.identities.forEach(id => {
                totalAnnounces += id.count;
                firstSeen = Math.min(firstSeen, id.first);
                lastSeen = Math.max(lastSeen, id.last);
                if (isActive(id.last)) activeIdentities++;
            });
            
            const elapsedTotal = lastSeen - firstSeen;
            const globalRateHz = elapsedTotal > 0 ? totalAnnounces / elapsedTotal : 0;
            const globalPeriod = globalRateHz > 0 ? 1 / globalRateHz : 0;
            
            document.getElementById('stat-total').textContent = totalAnnounces;
            document.getElementById('stat-identities').textContent = `${state.identities.size} (${activeIdentities} attive)`;
            document.getElementById('stat-rate').textContent = formatRate(globalRateHz);
            document.getElementById('stat-period').textContent = formatPeriod(globalPeriod);
            
            const aspectCount = new Map();
            state.identities.forEach(id => {
                id.aspects.forEach((data, asp) => {
                    if (ASPECTS.includes(asp)) {
                        aspectCount.set(asp, (aspectCount.get(asp) || 0) + data.count);
                    }
                });
            });
            
            let aspHtml = '';
            [...aspectCount.entries()].sort((a,b) => b[1] - a[1]).slice(0, 8).forEach(([asp, cnt]) => {
                aspHtml += `<div class="stat-card"><div style="display:flex; justify-content:space-between;">`;
                aspHtml += `<span style="color:var(--fg);">${asp.slice(0,12)} </span>`;
                aspHtml += `<span style="color:var(--dim);"> ${cnt} ann.</span>`;
                aspHtml += `</div></div>`;
            });
            document.getElementById('stats-aspects').innerHTML = aspHtml || '<div style="color:var(--dim);">nessun dato</div>';
            
            let idHtml = '';
            [...state.identities.values()]
                .sort((a,b) => b.count - a.count)
                .slice(0, 10)
                .forEach(id => {
                    const active = isActive(id.last);
                    const elapsed = id.last - id.first;
                    const idRateHz = elapsed > 0 && id.count > 1 ? id.count / elapsed : 0;
                    const idPeriod = idRateHz > 0 ? 1 / idRateHz : 0;
                    const lastData = decodeUTF8(id.lastData);
                    const cleanData = lastData ? lastData.replace(/[\x00-\x1F\x7F-\x9F]/g, '') : '';
                    const lastActiveAgo = Math.round((now - id.last) / 60);
                    
                    idHtml += `<div class="stat-card">`;
                    idHtml += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">`;
                    idHtml += `<span style="font-family:monospace; color:#8888ff;" title="${id.hash}">${id.hash.slice(0,16)}‚Ä¶</span>`;
                    if (cleanData) idHtml += `<span style="color:#88ff88; font-size:9px;">${cleanData.slice(0,16)}</span>`;
                    idHtml += `</div>`;
                    idHtml += `<div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px;">`;
                    idHtml += `<span style="color:var(--dim);">${id.count} ann.</span>`;
                    if (active) {
                        idHtml += `<span style="color:#ffff88;" title="frequenza: ${formatRate(idRateHz)}">‚ö° ${formatRate(idRateHz)}</span>`;
                        idHtml += `<span style="color:#88ffff;" title="periodo: ogni ${formatPeriod(idPeriod)}">‚è±Ô∏è ${formatPeriod(idPeriod)}</span>`;
                    } else {
                        idHtml += `<span class="inactive">üí§ ${lastActiveAgo} min</span>`;
                    }
                    idHtml += `</div>`;
                    idHtml += `<div style="display:flex; justify-content:space-between; margin-top:4px; font-size:9px; color:var(--dim);">`;
                    idHtml += `<span>${id.aspects.size} aspect</span>`;
                    idHtml += `<span>${Math.round(elapsed)}s di vita</span>`;
                    idHtml += `</div>`;
                    idHtml += `</div>`;
                });
            document.getElementById('stats-identities').innerHTML = idHtml || '<div style="color:var(--dim);">nessun dato</div>';
        }

        function loadCacheStats() {
            fetch('/api/monitor/cache/stats')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const stats = data.stats;
                        
                        document.getElementById('cache-size').textContent = stats.size || 0;
                        document.getElementById('cache-age').textContent = (stats.age_days || 0).toFixed(1);
                        document.getElementById('cache-saves').textContent = stats.stats?.save_count || 0;
                        document.getElementById('cache-file').textContent = stats.cache_file?.split('/').pop() || '-';
                        
                        // Mostra distribuzione aspect
                        let aspectsHtml = '';
                        const aspectEntries = Object.entries(stats.aspects || {}).sort((a,b) => b[1] - a[1]).slice(0, 8);
                        
                        aspectEntries.forEach(([asp, cnt]) => {
                            aspectsHtml += `<div class="stat-card"><div style="display:flex; justify-content:space-between;">`;
                            aspectsHtml += `<span style="color:var(--fg);">${asp.slice(0,15)} </span>`;
                            aspectsHtml += `<span style="color:var(--dim);"> ${cnt} ann.</span>`;
                            aspectsHtml += `</div></div>`;
                        });
                        
                        document.getElementById('cache-aspects').innerHTML = aspectsHtml || '<div style="color:var(--dim);">nessun dato</div>';
                    }
                })
                .catch(err => console.error('Errore caricamento cache stats:', err));
        }

        function updatePagination(total) {
            const pages = Math.ceil(total / state.limit) || 1;
            const start = (state.page - 1) * state.limit + 1;
            const end = Math.min(state.page * state.limit, total);
            
            document.getElementById('total-items').textContent = total;
            document.getElementById('showing-start').textContent = total ? start : 0;
            document.getElementById('showing-end').textContent = total ? end : 0;
            document.getElementById('page-info').textContent = `pagina ${state.page}/${pages}`;
            
            document.getElementById('prev-page').disabled = state.page <= 1;
            document.getElementById('next-page').disabled = state.page >= pages;
        }

        function loadHistory() {
            const source = state.cacheSource;
            
            const params = new URLSearchParams({
                aspect: state.aspect,
                search: state.search,
                limit: state.limit,
                offset: (state.page - 1) * state.limit,
                sort: state.sort,
                source: source
            });

            fetch(`/api/monitor/history?${params}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        let html = '';
                        data.announces.forEach(a => {
                            html += createAnnounceRow(a);
                            if (source === 'memory') {
                                updateIdentityStats(a);
                            }
                        });
                        document.getElementById('announce-body').innerHTML = html || '<tr><td colspan="7" style="text-align:center; padding:40px; color:var(--dim);">‚Äî nessun annuncio ‚Äî</td></tr>';
                        updatePagination(data.total);
                        if (window.updateAspectTabs) window.updateAspectTabs();
                    }
                })
                .catch(err => console.error('History error:', err));
        }

        function connectSSE() {
            const es = new EventSource('/api/monitor/stream');
            
            es.onopen = () => {
                document.getElementById('status').className = 'status online';
            };
            
            es.onmessage = (e) => {
                if (e.data) {
                    try {
                        const ann = JSON.parse(e.data);
                        if (ann.id > state.lastId) {
                            state.lastId = ann.id;
                            
                            fetch('/api/monitor/stats')
                                .then(r => r.json())
                                .then(s => {
                                    if (s.success) {
                                        document.getElementById('total-announces').textContent = s.total_announces || 0;
                                        document.getElementById('unique-sources').textContent = s.unique_sources || 0;
                                    }
                                });
                            
                            updateIdentityStats(ann);
                            if (window.updateAspectTabs) window.updateAspectTabs();
                            
                            if (state.view === 'live' && state.cacheSource === 'memory') {
                                let shouldShow = true;
                                
                                if (state.aspect !== 'all') {
                                    if (state.aspect === 'unknown') {
                                        shouldShow = ann.aspect === 'unknown' || !ann.aspect;
                                    } else if (state.aspect === 'known') {
                                        shouldShow = ann.aspect && ann.aspect !== 'unknown' && ann.aspect !== 'identity_hash' && ASPECTS.includes(ann.aspect);
                                    } else {
                                        shouldShow = ann.aspect === state.aspect;
                                    }
                                }
                                
                                if (shouldShow && state.search) {
                                    const searchLower = state.search.toLowerCase();
                                    shouldShow = 
                                        (ann.dest_hash && ann.dest_hash.toLowerCase().includes(searchLower)) ||
                                        (ann.identity_hash && ann.identity_hash.toLowerCase().includes(searchLower)) ||
                                        (ann.aspect && ann.aspect.toLowerCase().includes(searchLower)) ||
                                        (ann.data && ann.data.toLowerCase().includes(searchLower));
                                }
                                
                                if (shouldShow) {
                                    const tbody = document.getElementById('announce-body');
                                    const firstRow = tbody.querySelector('tr');
                                    
                                    if (firstRow && firstRow.innerHTML.includes('nessun annuncio')) {
                                        tbody.innerHTML = '';
                                    }
                                    
                                    const row = createAnnounceRow(ann);
                                    tbody.insertAdjacentHTML('afterbegin', row);
                                    
                                    resortLiveTable();
                                    
                                    const rows = tbody.querySelectorAll('tr');
                                    if (rows.length > state.limit) {
                                        rows[rows.length-1].remove();
                                    }
                                    
                                    const totalSpan = document.getElementById('total-items');
                                    if (totalSpan) {
                                        totalSpan.textContent = parseInt(totalSpan.textContent || '0') + 1;
                                    }
                                }
                            } else if (state.view === 'identities') {
                                renderIdentities();
                            } else if (state.view === 'stats') {
                                renderStats();
                            }
                        }
                    } catch(e) {
                        console.error('SSE parse error:', e);
                    }
                }
            };
            
            es.onerror = () => {
                document.getElementById('status').className = 'status offline';
                setTimeout(connectSSE, 3000);
            };
        }

        // ============================================
        // === FUNZIONE RESET TOTALE - VERSIONE MASSIMA ===
        // ============================================
        function resetAllCounters() {
            if (confirm('üí• RESET TOTALE: cancellare TUTTI i dati (statistiche, identit√†, cache e storico)?')) {
                
                // Blocca gli aggiornamenti durante il reset
                state.resetting = true;
                
                // Mostra messaggio di caricamento
                const originalBody = document.getElementById('announce-body').innerHTML;
                document.getElementById('announce-body').innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#ffff88;">üîÑ RESET IN CORSO... ATTENDERE</td></tr>';
                
                // 1. Chiama API per pulire backend (memoria)
                fetch('/api/monitor/clear', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Clear response:', data);
                    
                    // 2. Pulisci cache persistente su disco
                    return fetch('/api/monitor/cache/clear', { 
                        method: 'POST' 
                    });
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Cache clear response:', data);
                    
                    // 3. RESET COMPLETO DELLO STATO FRONTEND
                    state.identities = new Map();           // Svuota mappa identit√†
                    state.expandedIdentities.clear();       // Svuota set espansioni
                    state.lastId = 0;                        // Reset ultimo ID
                    
                    // 4. Pulisci localStorage COMPLETAMENTE
                    localStorage.removeItem(STORAGE_KEY);   // Rimuovi la chiave specifica
                    
                    // 5. AZZERA TUTTI I CONTATORI VISIBILI
                    document.getElementById('total-announces').textContent = '0';
                    document.getElementById('unique-sources').textContent = '0';
                    
                    // Statistiche generali
                    document.getElementById('stat-total').textContent = '0';
                    document.getElementById('stat-identities').textContent = '0 (0 attive)';
                    document.getElementById('stat-rate').textContent = '‚Äî';
                    document.getElementById('stat-period').textContent = '‚Äî';
                    
                    // 6. SVUOTA TABELLE
                    document.getElementById('announce-body').innerHTML = 
                        '<tr><td colspan="7" style="text-align:center; padding:40px; color:var(--dim);">‚Äî nessun annuncio ‚Äî</td></tr>';
                    
                    document.getElementById('identity-container').innerHTML = 
                        '<div style="color:var(--dim); text-align:center; padding:40px;">nessuna identit√†</div>';
                    
                    // 7. AZZERA I TAB DEGLI ASPECT
                    updateTabsWithZero();
                    
                    // 8. Forza refresh statistiche cache se visibili
                    if (state.view === 'cache') {
                        loadCacheStats();
                    }
                    
                    // 9. Ricarica la history (sar√† vuota)
                    state.page = 1;
                    loadHistory();
                    
                    // 10. Aggiorna i tab delle statistiche
                    renderStats();
                    renderIdentities();
                    
                    // 11. Messaggio di conferma
                    alert('‚úÖ RESET COMPLETO EFFETTUATO - Tutti i contatori azzerati');
                    
                })
                .catch(error => {
                    console.error('Errore durante il reset:', error);
                    alert('‚ùå Errore durante il reset: ' + error.message);
                    document.getElementById('announce-body').innerHTML = originalBody;
                })
                .finally(() => {
                    state.resetting = false;
                });
            }
        }

        // Funzione per azzerare i tab degli aspect
        function updateTabsWithZero() {
            const row1 = document.getElementById('aspect-row-1');
            const row2 = document.getElementById('aspect-row-2');
            const row3 = document.getElementById('aspect-row-3');
            
            if (!row1 || !row2 || !row3) return;
            
            let html1 = `<div class="tab-aspect ${state.aspect === 'all' ? 'active' : ''}" data-aspect="all">üìã tutti (0)</div>`;
            ASPECTS.slice(0, 10).forEach(a => {
                const short = a.split('.').pop();
                html1 += `<div class="tab-aspect ${state.aspect === a ? 'active' : ''}" data-aspect="${a}">${short} (0)</div>`;
            });
            row1.innerHTML = html1;
            
            let html2 = ``;
            ASPECTS.slice(10, 20).forEach(a => {
                const short = a.split('.').pop();
                html2 += `<div class="tab-aspect ${state.aspect === a ? 'active' : ''}" data-aspect="${a}">${short} (0)</div>`;
            });
            row2.innerHTML = html2;
            
            let html3 = ``;
            ASPECTS.slice(20).forEach(a => {
                const short = a.split('.').pop();
                html3 += `<div class="tab-aspect ${state.aspect === a ? 'active' : ''}" data-aspect="${a}">${short} (0)</div>`;
            });
            html3 += `<div class="tab-aspect ${state.aspect === 'known' ? 'active' : ''}" data-aspect="known">‚úì conosciuti (0)</div>`;
            html3 += `<div class="tab-aspect ${state.aspect === 'unknown' ? 'active' : ''}" data-aspect="unknown">? sconosciuti (0)</div>`;
            row3.innerHTML = html3;
            
            // Ricollega gli event listener
            document.querySelectorAll('.tab-aspect').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    document.querySelectorAll('.tab-aspect').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    state.aspect = this.dataset.aspect;
                    state.page = 1;
                    loadHistory();
                });
            });
        }

        function forceZeroTabs() {
            updateTabsWithZero();
        }

        function initEventListeners() {
            document.getElementById('sort-select').addEventListener('change', function() {
                state.sort = this.value;
                state.page = 1;
                loadHistory();
                setTimeout(resortLiveTable, 100);
            });

            document.getElementById('limit-select').addEventListener('change', function() {
                state.limit = parseInt(this.value);
                state.page = 1;
                loadHistory();
            });

            document.getElementById('search-input').addEventListener('input', function() {
                state.search = this.value.toLowerCase();
                state.page = 1;
                loadHistory();
            });

            document.getElementById('identity-search-input').addEventListener('input', function() {
                renderIdentities();
            });

            document.getElementById('cache-source-select').addEventListener('change', function() {
                state.cacheSource = this.value;
                state.page = 1;
                loadHistory();
            });

            // IMPORTANTE: Collega i pulsanti di reset alla funzione
            document.getElementById('clear-btn').addEventListener('click', resetAllCounters);
            document.getElementById('clear-all-btn').addEventListener('click', resetAllCounters);

            document.getElementById('cache-clear-btn').addEventListener('click', function() {
                if (confirm('PULIRE TUTTA LA CACHE PERSISTENTE SU DISCO?')) {
                    fetch('/api/monitor/cache/clear', { method: 'POST' })
                        .then(() => {
                            alert('Cache pulita');
                            if (state.view === 'cache') loadCacheStats();
                        });
                }
            });

            document.getElementById('cache-save-btn').addEventListener('click', function() {
                fetch('/api/monitor/cache/save', { method: 'POST' })
                    .then(() => {
                        alert('Cache salvata su disco');
                    });
            });

            document.getElementById('cache-cleanup-old').addEventListener('click', function() {
                fetch('/api/monitor/cache/cleanup', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        alert(`Rimossi ${data.removed} annunci vecchi`);
                        loadCacheStats();
                    });
            });

            document.getElementById('cache-refresh-stats').addEventListener('click', function() {
                loadCacheStats();
            });

            document.getElementById('cache-export').addEventListener('click', function() {
                window.open('/api/monitor/history/persistent?days=7&limit=5000', '_blank');
            });

            document.getElementById('prev-page').addEventListener('click', function() {
                if (state.page > 1) { state.page--; loadHistory(); }
            });

            document.getElementById('next-page').addEventListener('click', function() {
                state.page++; loadHistory();
            });

            document.getElementById('identity-sort-select').addEventListener('change', function() {
                renderIdentities();
            });

            document.querySelectorAll('.table th[data-sort]').forEach(th => {
                th.addEventListener('click', function() {
                    const sort = this.dataset.sort;
                    const currentSort = state.sort;
                    if (currentSort === sort + '_desc') {
                        state.sort = sort + '_asc';
                    } else if (currentSort === sort + '_asc') {
                        state.sort = sort + '_desc';
                    } else {
                        state.sort = sort + '_desc';
                    }
                    state.page = 1;
                    loadHistory();
                    document.getElementById('sort-select').value = state.sort;
                });
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modalState.visible) {
                    hideAspectModal();
                }
            });
        }

        function showOutput(message, type) {
            const output = document.getElementById('output');
            if (output) {
                output.innerHTML = `<span class="${type}">${message}</span>`;
            } else {
                console.log(message);
            }
        }

        // Inizializzazione
        loadIdentitiesFromStorage();
        initAspectTabs();
        initMainTabs();
        initEventListeners();
        connectSSE();
        loadHistory();
        
        setInterval(saveIdentitiesToStorage, 30000);
        setInterval(() => {
            if (state.view === 'identities') {
                renderIdentities();
            }
            if (state.view === 'stats') {
                renderStats();
            }
            if (state.view === 'live') {
                resortLiveTable();
            }
        }, 2000);
        
        window.addEventListener('beforeunload', saveIdentitiesToStorage);
    </script>
</body>
</html>