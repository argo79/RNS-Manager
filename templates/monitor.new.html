<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>RNS ‚Ä¢ monitor</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="/static/rns_monitor.css">
    <style>
        /* Stili aggiuntivi per i dati radio */
        .rssi-good { color: #88ff88; }
        .rssi-ok { color: #ffff88; }
        .rssi-poor { color: #ff8888; }
        .snr-good { color: #88ff88; }
        .snr-ok { color: #ffff88; }
        .snr-poor { color: #ff8888; }
        .q-good { color: #88ff88; }
        .q-ok { color: #ffff88; }
        .q-poor { color: #ff8888; }
        .radio-data { font-family: monospace; font-size: 11px; }
        
        /* Stili per hop */
        .badge-local {
            background: #2a2a00;
            color: #ffffaa;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .badge-hop1 {
            background: #1a3a1a;
            color: #aaffaa;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }
        
        .sort-indicator {
            margin-left: 4px;
            font-size: 10px;
        }

        /* Stili per colonne cliccabili */
        th[onclick] {
            cursor: pointer;
            user-select: none;
        }
        th[onclick]:hover {
            background: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>RETICULUM MONITOR 1.0.0</h1>
                <div class="header-subtitle">Monitoraggio annunci e identit√† Reticulum</div>
            </div>
            <div>
                <a href="/" class="back-button">‚Üê TORNA A IDENTITY MANAGER</a>
            </div>
        </header>

        <div style="margin: 20px 0; display: flex; gap: 20px; align-items: center;">
            <div class="stats">
                <span id="status" class="status offline"></span>
                <span id="total-announces">0</span> annunci ¬∑ <span id="unique-sources">0</span> identit√† uniche ¬∑ <span id="cache-size-indicator">0</span> in cache
            </div>
            <div style="flex:1;"></div>
            <div class="cache-controls" style="display: flex; gap: 10px; align-items: center;">
                <span style="color:var(--dim); font-size:11px;">üíæ cache:</span>
                <select id="cache-source-select" style="background:#1a1a1a; color:var(--fg); border:1px solid #333; padding:4px 8px; border-radius:4px;">
                    <option value="memory">üì± memoria (ultimi 1000)</option>
                    <option value="cache">üíæ disco (ultimi 7 giorni)</option>
                </select>
                <button class="btn" id="reset-all-btn" style="background:#550000; color:#ffaa00; font-size:11px; padding:4px 8px;">üîÑ RESET TOTALE</button>
            </div>
        </div>

        <div class="tabs-main">
            <div class="tab-main active" data-view="live">üì° live</div>
            <div class="tab-main" data-view="identities">üÜî identit√†</div>
            <div class="tab-main" data-view="stats">üìä statistiche</div>
        </div>

        <div id="view-live" class="view active">
            <div class="tabs-aspect-container" id="aspect-tabs-container">
                <div class="tabs-aspect-row" id="aspect-row-1"></div>
                <div class="tabs-aspect-row" id="aspect-row-2"></div>
                <div class="tabs-aspect-row" id="aspect-row-3"></div>
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label>mostra</label>
                    <select id="limit-select">
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>cerca</label>
                    <input type="text" id="search-input" placeholder="hash/aspect/dati" style="width: 180px;">
                    <button class="clear-search-btn" onclick="document.getElementById('search-input').value=''; state.search=''; state.page=1; loadHistory();" title="Pulisci ricerca">‚úï</button>
                </div>
            </div>

            <table class="table" id="announce-table">
                <thead>
                    <tr>
                        <th style="width:5%" onclick="setSort('time')">‚è± tempo<span id="sort-indicator-time" class="sort-indicator"></span></th>
                        <th style="width:13%" onclick="setSort('identity')">üÜî identit√† <span id="sort-indicator-identity" class="sort-indicator"></span></th>
                        <th style="width:13%" onclick="setSort('dest')">üéØ destinazione <span id="sort-indicator-dest" class="sort-indicator"></span></th>
                        <th style="width:15%" onclick="setSort('aspect')">üè∑ aspect <span id="sort-indicator-aspect" class="sort-indicator"></span></th>
                        <th style="width:5%" onclick="setSort('hops')">üì∂ hops<span id="sort-indicator-hops" class="sort-indicator"></span></th>
                        <th style="width:5%" onclick="setSort('rssi')">üì° RSSI<span id="sort-indicator-rssi" class="sort-indicator"></span></th>
                        <th style="width:5%" onclick="setSort('snr')">üìä SNR<span id="sort-indicator-snr" class="sort-indicator"></span></th>
                        <th style="width:5%" onclick="setSort('q')">‚ö° Q<span id="sort-indicator-q" class="sort-indicator"></span></th>
                        <th style="width:8%" onclick="setSort('iface')">üåê iface <span id="sort-indicator-iface" class="sort-indicator"></span></th>
                        <th style="width:17%" onclick="setSort('data')">üí¨ dati <span id="sort-indicator-data" class="sort-indicator"></span></th>
                    </tr>
                </thead>
                <tbody id="announce-body">
                    <tr><td colspan="10" style="text-align:center; padding:40px; color:var(--dim);">‚è≥ in attesa di annunci...</td></tr>
                </tbody>
            </table>

            <div class="pagination">
                <div><span id="showing-start">0</span>-<span id="showing-end">0</span> di <span id="total-items">0</span></div>
                <div style="display:flex; gap:8px;">
                    <button class="btn" id="prev-page">‚Üê</button>
                    <span id="page-info" style="padding:4px 0;">pagina 1</span>
                    <button class="btn" id="next-page">‚Üí</button>
                </div>
            </div>
        </div>

        <div id="view-identities" class="view">
            <div class="identity-sort-bar">
                <div class="sort-controls">
                    <span style="color:var(--dim);">ordina per:</span>
                    <select id="identity-sort-select" class="sort-select">
                        <option value="count_desc">üìä annunci (‚Üì)</option>
                        <option value="count_asc">üìä annunci (‚Üë)</option>
                        <option value="rate_desc">‚ö° frequenza (‚Üì)</option>
                        <option value="rate_asc">‚ö° frequenza (‚Üë)</option>
                        <option value="period_asc">‚è±Ô∏è periodo (‚Üë)</option>
                        <option value="period_desc">‚è±Ô∏è periodo (‚Üì)</option>
                        <option value="aspects_desc">üè∑ aspect (‚Üì)</option>
                        <option value="aspects_asc">üè∑ aspect (‚Üë)</option>
                        <option value="last_desc">‚è± ultimo (‚Üì)</option>
                        <option value="last_asc">‚è± ultimo (‚Üë)</option>
                        <option value="hash_asc">üîë hash (A‚ÜíZ)</option>
                        <option value="hash_desc">üîë hash (Z‚ÜíA)</option>
                    </select>
                </div>
                <div class="search-identity" style="display: flex; gap: 5px;">
                    <input type="text" id="identity-search-input" class="identity-search-input" placeholder="üîç cerca identit√†...">
                    <button class="clear-search-btn" onclick="document.getElementById('identity-search-input').value=''; state.identitySearch=''; renderIdentities();" title="Pulisci ricerca">‚úï</button>
                </div>
                <span style="flex:1; text-align:right; color:var(--dim);" id="identity-count">0 identit√†</span>
            </div>
            <div id="identity-container"></div>
        </div>

        <div id="view-stats" class="view">
            <div class="grid-2">
                <div class="stat-card">
                    <div class="stat-number" id="stat-total">0</div>
                    <div class="stat-label">annunci totali</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-identities">0</div>
                    <div class="stat-label">identit√†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-rate">0</div>
                    <div class="stat-label">frequenza media</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-period">0</div>
                    <div class="stat-label">periodo medio</div>
                </div>
            </div>
            
            <h3 style="font-size:12px; margin:20px 0 10px; font-weight:normal; color:var(--dim);">top aspect</h3>
            <div id="stats-aspects" class="grid-2" style="grid-template-columns:repeat(auto-fill, minmax(180px,1fr));"></div>
            
            <h3 style="font-size:12px; margin:20px 0 10px; font-weight:normal; color:var(--dim);">top identit√†</h3>
            <div id="stats-identities" class="grid-2" style="grid-template-columns:repeat(auto-fill, minmax(300px,1fr));"></div>
        </div>
    </div>

    <script>
        // ============================================
        // === CONFIGURAZIONE ===
        // ============================================
        
        const STORAGE_KEY = 'rns_monitor_identities';
        const INACTIVE_TIMEOUT = 3600;
        
        const ASPECTS = [
            "lxmf.delivery","nomadnetwork.node","lxst.telephony","call.audio","retibbs.bbs","rrc.hub","lxmf.propagation",
            "rnstransport.probe","rnstransport.info.blackhole","rnsh.listen","rnsh.default","rnsh","rncp","rncp.receive",
            "rns_unit_tests.link.establish",
            "rnstransport.discovery.interface",
            "rnstransport.tunnel.synthesize",
            "rnstransport.path.request",
            "rnstransport.remote.management",    
            "rnstransport.network.instance",
            "rnstransport.network",
            "example_utilities.minimalsample",
            "example_utilities.execute",
            "example_utilities.echo.request",
            "example_utilities.broadcast",
            "example_utilities.bufferexample",
            "example_utilities.channelexample",
            "example_utilities.filetransfer.server",
            "example_utilities.identifyexample",
            "example_utilities.linkexample",
            "example_utilities.ratchet.echo.request",
            "example_utilities.requestexample",
            "example_utilities.resourceexample",
            "example_utilities.speedtest","discovery.interface",
        ];

        // ============================================
        // === STATO MODALE PER I COMANDI ===
        // ============================================
        
        const modalState = {
            visible: false,
            identityHash: '',
            aspectHash: '',
            aspect: '',
            identityPath: null
        };

        const state = {
            view: 'live',
            aspect: 'all',
            page: 1,
            limit: 100,
            sort: 'time_desc',
            search: '',
            identitySearch: '',
            lastId: 0,
            identities: new Map(),
            expandedIdentities: new Set(),
            identitySort: 'count_desc',
            cacheSource: 'memory',
            resetting: false,
            eventSource: null,
            backendStats: { total: 0, unique: 0, cacheSize: 0 },
            reconnectAttempt: 1,
            connecting: false
        };

        // ============================================
        // === VARIABILE GLOBALE PER TUTTI GLI ANNUNCI ===
        // ============================================
        window._allAnnounces = [];

        // ============================================
        // === FUNZIONI ORDINAMENTO COLONNE ===
        // ============================================

        function setSort(field) {
            const currentSort = state.sort;
            let direction = 'desc';
            
            if (currentSort.startsWith(field)) {
                if (currentSort.endsWith('_desc')) {
                    direction = 'asc';
                } else if (currentSort.endsWith('_asc')) {
                    direction = 'desc';
                }
            }
            
            state.sort = `${field}_${direction}`;
            state.page = 1;
            
            updateSortIndicators();
            
            // Usa l'array globale se disponibile, altrimenti ricarica
            if (window._allAnnounces && window._allAnnounces.length > 0) {
                applyCurrentSortAndRender();
            } else {
                loadHistory();
            }
        }

        function updateSortIndicators() {
            const indicators = {
                time: document.getElementById('sort-indicator-time'),
                identity: document.getElementById('sort-indicator-identity'),
                dest: document.getElementById('sort-indicator-dest'),
                aspect: document.getElementById('sort-indicator-aspect'),
                hops: document.getElementById('sort-indicator-hops'),
                rssi: document.getElementById('sort-indicator-rssi'),
                snr: document.getElementById('sort-indicator-snr'),
                q: document.getElementById('sort-indicator-q'),
                iface: document.getElementById('sort-indicator-iface'),
                data: document.getElementById('sort-indicator-data')
            };
            
            Object.values(indicators).forEach(ind => {
                if (ind) ind.innerHTML = '';
            });
            
            const [field, dir] = state.sort.split('_');
            if (indicators[field]) {
                indicators[field].innerHTML = dir === 'desc' ? '‚ñº' : '‚ñ≤';
            }
        }

        // ============================================
        // === FUNZIONI DI UTILIT√Ä ===
        // ============================================

        function decodeUTF8(str) {
            if (!str) return '';
            try {
                return decodeURIComponent(escape(str));
            } catch(e) {
                return str;
            }
        }

        function formatRate(rateHz) {
            if (rateHz >= 1) return rateHz.toFixed(2) + ' Hz';
            if (rateHz >= 0.001) return (rateHz * 1000).toFixed(1) + ' mHz';
            if (rateHz > 0) return (rateHz * 1000000).toFixed(0) + ' ¬µHz';
            return '‚Äî';
        }

        function formatPeriod(periodSeconds) {
            if (periodSeconds >= 3600) return (periodSeconds / 3600).toFixed(1) + ' h';
            if (periodSeconds >= 60) return (periodSeconds / 60).toFixed(1) + ' min';
            if (periodSeconds >= 1) return periodSeconds.toFixed(1) + ' s';
            if (periodSeconds > 0) return (periodSeconds * 1000).toFixed(0) + ' ms';
            return '‚Äî';
        }

        function isActive(timestamp) {
            const now = Date.now() / 1000;
            return (now - timestamp) < INACTIVE_TIMEOUT;
        }

        function getRSSIClass(rssi) {
            if (rssi === null || rssi === undefined) return '';
            if (rssi > -70) return 'rssi-good';
            if (rssi > -85) return 'rssi-ok';
            return 'rssi-poor';
        }

        function getSNRClass(snr) {
            if (snr === null || snr === undefined) return '';
            if (snr > 15) return 'snr-good';
            if (snr > 5) return 'snr-ok';
            return 'snr-poor';
        }

        function getQClass(q) {
            if (q === null || q === undefined) return '';
            if (q > 80) return 'q-good';
            if (q > 50) return 'q-ok';
            return 'q-poor';
        }

        // ============================================
        // === FUNZIONI DI ORDINAMENTO TABELLA ===
        // ============================================

        function getNumericHops(hopText) {
            if (hopText === 'üè† locale') return 0;
            if (hopText === '?') return 999;
            const num = parseInt(hopText);
            return isNaN(num) ? 999 : num;
        }

        // ============================================
        // === APPLICA ORDINAMENTO E RENDERIZZA ===
        // ============================================

        function applyCurrentSortAndRender() {
            if (!window._allAnnounces || window._allAnnounces.length === 0) {
                document.getElementById('announce-body').innerHTML = '<tr><td colspan="10" style="text-align:center; padding:40px; color:var(--dim);">‚Äî nessun annuncio ‚Äî</td></tr>';
                updatePagination(0);
                return;
            }
            
            // Clona l'array per non modificare l'originale
            const sorted = [...window._allAnnounces];
            
            // Applica l'ordinamento corrente
            switch(state.sort) {
                case 'time_desc':
                    sorted.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    break;
                case 'time_asc':
                    sorted.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    break;
                case 'rssi_desc':
                    sorted.sort((a, b) => (b.rssi || -999) - (a.rssi || -999));
                    break;
                case 'rssi_asc':
                    sorted.sort((a, b) => (a.rssi || 999) - (b.rssi || 999));
                    break;
                case 'snr_desc':
                    sorted.sort((a, b) => (b.snr || -999) - (a.snr || -999));
                    break;
                case 'snr_asc':
                    sorted.sort((a, b) => (a.snr || 999) - (b.snr || 999));
                    break;
                case 'q_desc':
                    sorted.sort((a, b) => (b.q || 0) - (a.q || 0));
                    break;
                case 'q_asc':
                    sorted.sort((a, b) => (a.q || 0) - (b.q || 0));
                    break;
                case 'hops_desc':
                    sorted.sort((a, b) => (parseInt(b.hops) || 0) - (parseInt(a.hops) || 0));
                    break;
                case 'hops_asc':
                    sorted.sort((a, b) => (parseInt(a.hops) || 999) - (parseInt(b.hops) || 999));
                    break;
                case 'aspect_desc':
                    sorted.sort((a, b) => (b.aspect || '').localeCompare(a.aspect || ''));
                    break;
                case 'aspect_asc':
                    sorted.sort((a, b) => (a.aspect || '').localeCompare(b.aspect || ''));
                    break;
                case 'identity_desc':
                    sorted.sort((a, b) => (b.identity_hash || '').localeCompare(a.identity_hash || ''));
                    break;
                case 'identity_asc':
                    sorted.sort((a, b) => (a.identity_hash || '').localeCompare(b.identity_hash || ''));
                    break;
                case 'dest_desc':
                    sorted.sort((a, b) => (b.dest_hash || '').localeCompare(a.dest_hash || ''));
                    break;
                case 'dest_asc':
                    sorted.sort((a, b) => (a.dest_hash || '').localeCompare(b.dest_hash || ''));
                    break;
                case 'iface_desc':
                    sorted.sort((a, b) => (b.interface || '').localeCompare(a.interface || ''));
                    break;
                case 'iface_asc':
                    sorted.sort((a, b) => (a.interface || '').localeCompare(b.interface || ''));
                    break;
                case 'data_desc':
                    sorted.sort((a, b) => (b.data || '').localeCompare(a.data || ''));
                    break;
                case 'data_asc':
                    sorted.sort((a, b) => (a.data || '').localeCompare(b.data || ''));
                    break;
                default:
                    sorted.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            }
            
            // Applica filtro search se presente
            let filtered = sorted;
            if (state.search) {
                const searchLower = state.search.toLowerCase();
                filtered = sorted.filter(a => 
                    (a.dest_hash && a.dest_hash.toLowerCase().includes(searchLower)) ||
                    (a.identity_hash && a.identity_hash.toLowerCase().includes(searchLower)) ||
                    (a.aspect && a.aspect.toLowerCase().includes(searchLower)) ||
                    (a.data && a.data.toLowerCase().includes(searchLower)) ||
                    (a.interface && a.interface.toLowerCase().includes(searchLower))
                );
            }
            
            // Applica filtro aspect se presente
            if (state.aspect !== 'all') {
                if (state.aspect === 'unknown') {
                    filtered = filtered.filter(a => a.aspect === 'unknown' || !a.aspect);
                } else if (state.aspect === 'known') {
                    filtered = filtered.filter(a => a.aspect && a.aspect !== 'unknown' && a.aspect !== 'identity_hash' && ASPECTS.includes(a.aspect));
                } else {
                    filtered = filtered.filter(a => a.aspect === state.aspect);
                }
            }
            
            // Paginazione
            const start = (state.page - 1) * state.limit;
            const paginated = filtered.slice(start, start + state.limit);
            
            // Renderizza
            let html = '';
            paginated.forEach(a => {
                html += createAnnounceRow(a);
            });
            
            document.getElementById('announce-body').innerHTML = html || '<tr><td colspan="10" style="text-align:center; padding:40px; color:var(--dim);">‚Äî nessun annuncio ‚Äî</td></tr>';
            
            // Aggiorna paginazione con il totale filtrato
            updatePagination(filtered.length);
            
            console.log(`üìä Renderizzati ${paginated.length} annunci (filtrati: ${filtered.length}, totali: ${window._allAnnounces.length})`);
        }

        // ============================================
        // === FUNZIONI MODAL (PROBE, PATH, BLACKHOLE) ===
        // ============================================

        function showIdentityInTab(identityHash) {
            document.querySelectorAll('.tab-main').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-view="identities"]').classList.add('active');
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-identities').classList.add('active');
            state.view = 'identities';
            
            document.getElementById('identity-search-input').value = identityHash;
            state.identitySearch = identityHash;
            renderIdentities();
        }

        function hideAspectModal() {
            const modal = document.getElementById('aspect-modal');
            if (modal) {
                modal.classList.remove('visible');
                modalState.visible = false;
            }
        }

        function executeRnsCommand(command, destination, aspect = null) {
            const outputDiv = document.getElementById('modal-output');
            if (!outputDiv) return;
            
            outputDiv.innerHTML = '‚è≥ Esecuzione in corso...';
            outputDiv.style.color = '#88ff88';
            
            if (command === 'path') {
                fetch(`/api/rns/paths?dest=${encodeURIComponent(destination)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            let output = data.output || '';
                            const lines = output.split('\n');
                            let cleanOutput = '';
                            
                            for (let i = lines.length - 1; i >= 0; i--) {
                                if (lines[i].includes('Path found')) {
                                    cleanOutput = lines[i];
                                    break;
                                }
                            }
                            
                            if (cleanOutput) {
                                cleanOutput = cleanOutput
                                    .replace(/.\u0008/g, '')
                                    .replace(/[\u2800-\u28FF]/g, '')
                                    .replace(/\s+/g, ' ')
                                    .trim()
                                    .replace(/&/g, '&amp;')
                                    .replace(/</g, '&lt;')
                                    .replace(/>/g, '&gt;');
                                outputDiv.innerHTML = cleanOutput;
                            } else {
                                output = output
                                    .replace(/.\u0008/g, '')
                                    .replace(/[\u2800-\u28FF]/g, '')
                                    .replace(/\s+/g, ' ')
                                    .trim()
                                    .replace(/&/g, '&amp;')
                                    .replace(/</g, '&lt;')
                                    .replace(/>/g, '&gt;');
                                outputDiv.innerHTML = output || '‚úÖ Comando eseguito';
                            }
                        } else {
                            outputDiv.innerHTML = `‚ùå Errore: ${data.error || 'Comando fallito'}`;
                            outputDiv.style.color = '#ff6666';
                        }
                    })
                    .catch(err => {
                        outputDiv.innerHTML = `‚ùå Errore: ${err.message}`;
                        outputDiv.style.color = '#ff6666';
                    });
            } else if (command === 'probe') {
                fetch('/api/rns/probe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        destination: destination, 
                        aspect: aspect || 'rnstransport.probe'
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            let output = data.output || '';
                            output = output
                                .replace(/.\u0008/g, '')
                                .replace(/[\u2800-\u28FF]/g, '')
                                .split('\n')
                                .filter(line => line.trim() && !line.includes('Sent probe'))
                                .join('\n')
                                .trim()
                                .replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;');
                            outputDiv.innerHTML = output || '‚úÖ Probe inviato';
                        } else {
                            outputDiv.innerHTML = `‚ùå Errore: ${data.error}`;
                            outputDiv.style.color = '#ff6666';
                        }
                    })
                    .catch(err => {
                        outputDiv.innerHTML = `‚ùå Errore: ${err.message}`;
                        outputDiv.style.color = '#ff6666';
                    });
            } else if (command === 'blackhole') {
                fetch('/api/rns/paths/blackhole', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ destination: destination })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            let output = data.output || '';
                            output = output
                                .replace(/.\u0008/g, '')
                                .replace(/[\u2800-\u28FF]/g, '')
                                .split('\n')
                                .filter(line => line.trim())
                                .join('\n')
                                .trim()
                                .replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;');
                            outputDiv.innerHTML = output || '‚úÖ Nessun blackhole trovato';
                        } else {
                            outputDiv.innerHTML = `‚ùå Errore: ${data.error}`;
                        }
                    })
                    .catch(err => {
                        outputDiv.innerHTML = `‚ùå Errore: ${err.message}`;
                    });
            }
        }

        function showAspectModal(identityHash, aspect, destHash) {
            modalState.identityHash = identityHash;
            modalState.aspect = aspect;
            modalState.aspectHash = destHash;
            
            fetch(`/api/identities/find/by-hash?hash=${identityHash}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        modalState.identityPath = data.identity_path;
                    }
                })
                .catch(err => console.error('Errore ricerca identit√†:', err));
            
            let modal = document.getElementById('aspect-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'aspect-modal';
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="hideAspectModal()"></div>
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>üè∑ Dettagli Aspect</h3>
                            <button class="modal-close" onclick="hideAspectModal()">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <div class="modal-info">
                                <div class="info-row">
                                    <span class="info-label">Identit√†:</span>
                                    <span class="info-value identity-hash" id="modal-identity-hash"></span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Aspect:</span>
                                    <span class="info-value" id="modal-aspect"></span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Hash Aspect:</span>
                                    <span class="info-value monospace" id="modal-aspect-hash"></span>
                                </div>
                            </div>
                            <div class="modal-actions" id="modal-actions"></div>
                            <div class="modal-output" id="modal-output"></div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('modal-identity-hash').textContent = identityHash;
            document.getElementById('modal-identity-hash').onclick = () => {
                hideAspectModal();
                showIdentityInTab(identityHash);
            };
            document.getElementById('modal-aspect').textContent = aspect;
            document.getElementById('modal-aspect-hash').textContent = destHash;
            
            const actionsDiv = document.getElementById('modal-actions');
            actionsDiv.innerHTML = '';
            
            const pathBtn = document.createElement('button');
            pathBtn.className = 'modal-btn';
            pathBtn.innerHTML = 'üõ£Ô∏è rnpath';
            pathBtn.onclick = () => executeRnsCommand('path', destHash);
            actionsDiv.appendChild(pathBtn);
            
            if (aspect === 'rnstransport.probe') {
                const probeBtn = document.createElement('button');
                probeBtn.className = 'modal-btn probe';
                probeBtn.innerHTML = 'üì° rnprobe';
                probeBtn.onclick = () => executeRnsCommand('probe', destHash, aspect);
                actionsDiv.appendChild(probeBtn);
            }
            
            if (aspect === 'rnstransport.info.blackhole') {
                const blackholeBtn = document.createElement('button');
                blackholeBtn.className = 'modal-btn blackhole';
                blackholeBtn.innerHTML = 'üï≥Ô∏è rnpath -p';
                blackholeBtn.onclick = () => executeRnsCommand('blackhole', modalState.identityHash);
                actionsDiv.appendChild(blackholeBtn);
            }

            modal.classList.add('visible');
            modalState.visible = true;
        }

        // ============================================
        // === FUNZIONI DI BACKEND ===
        // ============================================

        function refreshBackendStats() {
            return fetch('/api/monitor/stats')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        state.backendStats = {
                            total: data.total_announces || 0,
                            unique: data.unique_sources || 0,
                            cacheSize: data.cache?.size || 0
                        };
                        
                        document.getElementById('total-announces').textContent = state.backendStats.total;
                        document.getElementById('unique-sources').textContent = state.backendStats.unique;
                        document.getElementById('cache-size-indicator').textContent = state.backendStats.cacheSize;
                    }
                })
                .catch(err => console.error('Errore refresh stats:', err));
        }

        // ============================================
        // === ASPECT TABS ===
        // ============================================

        function getAspectCounts() {
            const counts = new Map();
            
            counts.set('all', 0);
            counts.set('known', 0);
            counts.set('unknown', 0);
            ASPECTS.forEach(a => counts.set(a, 0));
            
            // Se siamo in modalit√† cache, usa l'array globale
            if (state.cacheSource === 'cache' && window._allAnnounces && window._allAnnounces.length > 0) {
                window._allAnnounces.forEach(ann => {
                    const asp = ann.aspect || 'unknown';
                    if (ASPECTS.includes(asp)) {
                        counts.set(asp, (counts.get(asp) || 0) + 1);
                        counts.set('known', (counts.get('known') || 0) + 1);
                        counts.set('all', (counts.get('all') || 0) + 1);
                    } else {
                        counts.set('unknown', (counts.get('unknown') || 0) + 1);
                        counts.set('all', (counts.get('all') || 0) + 1);
                    }
                });
                return counts;
            }
            
            // Calcola i conteggi dalle identit√† (per modalit√† memory)
            state.identities.forEach(id => {
                id.aspects.forEach((data, asp) => {
                    const count = data.count || 1;
                    
                    if (ASPECTS.includes(asp)) {
                        counts.set(asp, (counts.get(asp) || 0) + count);
                        counts.set('known', (counts.get('known') || 0) + count);
                        counts.set('all', (counts.get('all') || 0) + count);
                    } else if (asp !== 'identity_hash') {
                        counts.set('unknown', (counts.get('unknown') || 0) + count);
                        counts.set('all', (counts.get('all') || 0) + count);
                    }
                });
            });
            
            return counts;
        }

        function initAspectTabs() {
            const row1 = document.getElementById('aspect-row-1');
            const row2 = document.getElementById('aspect-row-2');
            const row3 = document.getElementById('aspect-row-3');
            
            function renderAspectTabs() {
                const counts = getAspectCounts();
                
                row1.innerHTML = '';
                row2.innerHTML = '';
                row3.innerHTML = '';
                
                let html1 = `<div class="tab-aspect ${state.aspect === 'all' ? 'active' : ''}" data-aspect="all">üìã tutti (${counts.get('all') || 0})</div>`;
                ASPECTS.slice(0, 10).forEach(a => {
                    const short = a.split('.').pop();
                    const count = counts.get(a) || 0;
                    html1 += `<div class="tab-aspect ${state.aspect === a ? 'active' : ''}" data-aspect="${a}">${short} (${count})</div>`;
                });
                row1.innerHTML = html1;
                
                let html2 = ``;
                ASPECTS.slice(10, 20).forEach(a => {
                    const short = a.split('.').pop();
                    const count = counts.get(a) || 0;
                    html2 += `<div class="tab-aspect ${state.aspect === a ? 'active' : ''}" data-aspect="${a}">${short} (${count})</div>`;
                });
                row2.innerHTML = html2;
                
                let html3 = ``;
                ASPECTS.slice(20).forEach(a => {
                    const short = a.split('.').pop();
                    const count = counts.get(a) || 0;
                    html3 += `<div class="tab-aspect ${state.aspect === a ? 'active' : ''}" data-aspect="${a}">${short} (${count})</div>`;
                });
                html3 += `<div class="tab-aspect ${state.aspect === 'known' ? 'active' : ''}" data-aspect="known">‚úì conosciuti (${counts.get('known') || 0})</div>`;
                html3 += `<div class="tab-aspect ${state.aspect === 'unknown' ? 'active' : ''}" data-aspect="unknown">? sconosciuti (${counts.get('unknown') || 0})</div>`;
                row3.innerHTML = html3;
                
                document.querySelectorAll('.tab-aspect').forEach(tab => {
                    const newTab = tab.cloneNode(true);
                    tab.parentNode.replaceChild(newTab, tab);
                    
                    newTab.addEventListener('click', function(e) {
                        document.querySelectorAll('.tab-aspect').forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        state.aspect = this.dataset.aspect;
                        state.page = 1;
                        applyCurrentSortAndRender();
                    });
                });
            }
            
            renderAspectTabs();
            window.updateAspectTabs = renderAspectTabs;
        }

        function initMainTabs() {
            document.querySelectorAll('.tab-main').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab-main').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                    document.getElementById(`view-${this.dataset.view}`).classList.add('active');
                    state.view = this.dataset.view;
                    
                    if (state.view === 'identities') renderIdentities();
                    if (state.view === 'stats') renderStats();
                });
            });
        }

        // ============================================
        // === RENDERING TABELLA CON DATI RADIO ===
        // ============================================

        function createAnnounceRow(a) {
            const idShort = a.identity_hash?.slice(0, 32) || '?';
            const destShort = a.dest_hash?.slice(0, 32) || '-';
            const decodedData = decodeUTF8(a.data || '');
            
            const rssiClass = getRSSIClass(a.rssi);
            const snrClass = getSNRClass(a.snr);
            const qClass = getQClass(a.q);
            
            const rssiDisplay = a.rssi !== undefined && a.rssi !== null ? a.rssi.toFixed(1) : '-';
            const snrDisplay = a.snr !== undefined && a.snr !== null ? a.snr.toFixed(1) : '-';
            const qDisplay = a.q !== undefined && a.q !== null ? a.q.toFixed(1) : '-';
            
            let hopsDisplay = a.hops !== undefined && a.hops !== null ? a.hops : '?';
            let hopsClass = '';
            if (a.hops === 0) {
                hopsDisplay = 'üè† locale';
                hopsClass = 'badge-local';
            } else if (a.hops === 1) {
                hopsClass = 'badge-hop1';
            }
            
            let row = '<tr>';
            row += `<td style="white-space:nowrap; color:var(--dim);">${a.time || ''}</td>`;
            row += `<td class="identity" title="${a.identity_hash || ''}"><span class="clickable-hash" onclick="showIdentityInTab('${a.identity_hash}')">${idShort}</span></td>`;
            row += `<td class="dest" title="${a.dest_hash || ''}"><span class="clickable-hash" onclick="showAspectModal('${a.identity_hash}', '${a.aspect || 'unknown'}', '${a.dest_hash}')">${destShort}</span></td>`;
            
            if (a.aspect && a.aspect !== 'unknown' && a.aspect !== 'identity_hash') {
                row += `<td><span class="badge">${a.aspect}</span></td>`;
            } else {
                row += `<td><span class="unknown">sconosciuto</span></td>`;
            }
            
            row += `<td style="text-align:center;"><span class="${hopsClass}">${hopsDisplay}</span></td>`;
            row += `<td class="${rssiClass} radio-data">${rssiDisplay}</td>`;
            row += `<td class="${snrClass} radio-data">${snrDisplay}</td>`;
            row += `<td class="${qClass} radio-data">${qDisplay}</td>`;
            row += `<td class="iface">${a.interface?.split('[')[0] || '?'}</td>`;
            row += `<td class="data" style="font-family: monospace;">${decodedData || ''}</td>`;
            row += '</tr>';
            
            return row;
        }

        // ============================================
        // === GESTIONE IDENTIT√Ä ===
        // ============================================

        function saveIdentitiesToStorage() {
            try {
                const identitiesArray = [];
                state.identities.forEach((value, key) => {
                    identitiesArray.push({
                        hash: key,
                        first: value.first,
                        last: value.last,
                        count: value.count,
                        lastData: value.lastData,
                        aspects: Array.from(value.aspects.entries()).map(([asp, data]) => ({
                            aspect: asp,
                            dest: data.dest,
                            count: data.count,
                            last: data.last,
                            data: data.data
                        }))
                    });
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    timestamp: Date.now(),
                    identities: identitiesArray
                }));
            } catch(e) {
                console.warn('Errore salvataggio:', e);
            }
        }

        function loadIdentitiesFromStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) return false;
                
                const data = JSON.parse(stored);
                const age = (Date.now() - data.timestamp) / 1000;
                
                if (age > 3600) {
                    localStorage.removeItem(STORAGE_KEY);
                    return false;
                }
                
                state.identities.clear();
                data.identities.forEach(item => {
                    const aspects = new Map();
                    item.aspects.forEach(asp => {
                        aspects.set(asp.aspect, {
                            dest: asp.dest,
                            count: asp.count,
                            last: asp.last,
                            data: asp.data
                        });
                    });
                    
                    state.identities.set(item.hash, {
                        hash: item.hash,
                        first: item.first,
                        last: item.last,
                        count: item.count,
                        lastData: item.lastData,
                        aspects: aspects
                    });
                });
                
                return true;
            } catch(e) {
                console.warn('Errore caricamento:', e);
                return false;
            }
        }

        // ============================================
        // === UPDATE IDENTITY STATS ===
        // ============================================

        function updateIdentityStats(ann) {
            if (state.resetting || !ann.identity_hash) return;
            
            if (!window._processedAnnounces) {
                window._processedAnnounces = new Set();
            }
            
            const announceId = ann.packet_hash || `${ann.identity_hash}_${ann.timestamp}`;
            
            if (window._processedAnnounces.has(announceId)) {
                console.log('‚è≠Ô∏è Annuncio gi√† processato:', announceId.slice(0,16));
                return;
            }
            
            window._processedAnnounces.add(announceId);
            
            if (window._processedAnnounces.size > 10000) {
                const iterator = window._processedAnnounces.values();
                for (let i = 0; i < 1000; i++) {
                    window._processedAnnounces.delete(iterator.next().value);
                }
            }
            
            const id = ann.identity_hash.slice(0, 32);
            
            if (!state.identities.has(id)) {
                state.identities.set(id, {
                    hash: id,
                    first: ann.timestamp,
                    last: ann.timestamp,
                    count: 0,
                    aspects: new Map(),
                    lastData: ann.data
                });
            }
            
            const ident = state.identities.get(id);
            ident.last = Math.max(ident.last, ann.timestamp);
            ident.first = Math.min(ident.first, ann.timestamp);
            ident.count++;
            if (ann.data) ident.lastData = ann.data;
            
            const aspect = ann.aspect || 'unknown';
            if (!ident.aspects.has(aspect)) {
                ident.aspects.set(aspect, {
                    dest: ann.dest_hash,
                    count: 0,
                    last: ann.timestamp,
                    data: ann.data
                });
            }
            const asp = ident.aspects.get(aspect);
            asp.count++;
            asp.last = ann.timestamp;
            if (ann.data) asp.data = ann.data;
            
            saveIdentitiesToStorage();
            if (window.updateAspectTabs) window.updateAspectTabs();
        }

        function identityPassesSearch(identity, searchTerm) {
            if (!searchTerm) return true;
            const term = searchTerm.toLowerCase();
            if (identity.hash.toLowerCase().includes(term)) return true;
            if (identity.lastData && identity.lastData.toLowerCase().includes(term)) return true;
            for (let [asp, data] of identity.aspects) {
                if (asp.toLowerCase().includes(term)) return true;
                if (data.dest && data.dest.toLowerCase().includes(term)) return true;
                if (data.data && data.data.toLowerCase().includes(term)) return true;
            }
            return false;
        }

        function getIdentitySortFunction() {
            const sortValue = document.getElementById('identity-sort-select')?.value || 'count_desc';
            
            let [field, direction] = sortValue.split('_');
            const dir = direction === 'desc' ? -1 : 1;
            
            return (a, b) => {
                try {
                    switch(field) {
                        case 'count':
                            return dir * (b.count - a.count);
                        case 'rate': {
                            const aActive = isActive(a.last);
                            const bActive = isActive(b.last);
                            if (!aActive && !bActive) return 0;
                            if (!aActive) return 1;
                            if (!bActive) return -1;
                            const rateA = a.count / ((a.last - a.first) || 1);
                            const rateB = b.count / ((b.last - b.first) || 1);
                            return dir * (rateB - rateA);
                        }
                        case 'period': {
                            const aActive = isActive(a.last);
                            const bActive = isActive(b.last);
                            if (!aActive && !bActive) return 0;
                            if (!aActive) return 1;
                            if (!bActive) return -1;
                            const rateA = a.count / ((a.last - a.first) || 1);
                            const rateB = b.count / ((b.last - b.first) || 1);
                            const periodA = rateA > 0 ? 1 / rateA : Infinity;
                            const periodB = rateB > 0 ? 1 / rateB : Infinity;
                            return dir * (periodA - periodB);
                        }
                        case 'aspects':
                            return dir * (b.aspects.size - a.aspects.size);
                        case 'last':
                            return dir * (b.last - a.last);
                        case 'hash':
                            return dir * a.hash.localeCompare(b.hash);
                        default:
                            return dir * (b.count - a.count);
                    }
                } catch(e) {
                    return 0;
                }
            };
        }

        function renderIdentities() {
            const container = document.getElementById('identity-container');
            let html = '';
            
            const searchTerm = document.getElementById('identity-search-input')?.value || '';
            state.identitySearch = searchTerm;
            
            let filteredIdentities = [...state.identities.values()];
            if (searchTerm) {
                filteredIdentities = filteredIdentities.filter(id => identityPassesSearch(id, searchTerm));
            }
            
            const sorted = filteredIdentities.sort(getIdentitySortFunction());
            document.getElementById('identity-count').textContent = `${sorted.length} identit√†${searchTerm ? ' (filtrate)' : ''}`;
            
            sorted.slice(0, 100).forEach(id => {
                const now = Date.now() / 1000;
                const active = isActive(id.last);
                const elapsedSeconds = id.last - id.first;
                
                let rateHz = 0;
                let rateFormatted = '‚Äî';
                let periodFormatted = '‚Äî';
                let periodSeconds = 0;
                
                if (elapsedSeconds > 0 && id.count > 1 && active) {
                    rateHz = id.count / elapsedSeconds;
                    rateFormatted = formatRate(rateHz);
                    periodSeconds = 1 / rateHz;
                    periodFormatted = formatPeriod(periodSeconds);
                } else if (!active && id.count > 0) {
                    rateFormatted = 'üí§ inattivo';
                    periodFormatted = '‚Äî';
                }
                
                const isExpanded = state.expandedIdentities.has(id.hash);
                const lastData = decodeUTF8(id.lastData);
                const lastActiveAgo = Math.round((now - id.last) / 60);
                
                html += `<div class="identity-group" data-identity-hash="${id.hash}">`;
                html += `<div class="identity-header ${isExpanded ? 'expanded' : ''}" onclick="toggleIdentity('${id.hash}', this)">`;
                html += `<div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">`;
                html += `<span class="identity-hash" title="${id.hash}"> ${id.hash.slice(0,32)} </span>`;
                html += `<span style="color:var(--fg);"> ${id.count} annunci</span>`;
                
                if (active) {
                    html += `<span style="color:#ffff88; font-size:10px;" title="frequenza: ${rateFormatted}">‚ö° ${rateFormatted}</span>`;
                    html += `<span style="color:#88ffff; font-size:10px;" title="periodo: ogni ${periodFormatted}">‚è±Ô∏è ${periodFormatted}</span>`;
                } else {
                    html += `<span class="inactive" style="font-size:10px;">üí§ ${lastActiveAgo} min fa</span>`;
                }
                
                if (lastData) {
                    html += `<span class="app-data-preview">üìã ${lastData.slice(0,40)}</span>`;
                }
                html += `</div>`;
                html += `<span style="color:var(--dim);">${id.aspects.size} aspect</span>`;
                html += `</div>`;
                html += `<div class="aspect-list ${isExpanded ? 'expanded' : ''}">`;
                
                const aspects = [...id.aspects.entries()].sort((a,b) => b[1].count - a[1].count);
                aspects.forEach(([asp, data]) => {
                    const aspActive = isActive(data.last);
                    let aspRateHz = 0;
                    let aspRateFormatted = '‚Äî';
                    let aspPeriodFormatted = '‚Äî';
                    
                    if (elapsedSeconds > 0 && data.count > 1 && aspActive) {
                        aspRateHz = data.count / elapsedSeconds;
                        aspRateFormatted = formatRate(aspRateHz);
                        const aspPeriodSeconds = 1 / aspRateHz;
                        aspPeriodFormatted = formatPeriod(aspPeriodSeconds);
                    }
                    
                    const destShort = data.dest ? `${data.dest.slice(0,32)}` : '-';
                    const aspData = decodeUTF8(data.data);
                    
                    html += `<div class="aspect-item">`;
                    html += `<div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">`;
                    html += `<span class="badge" style="background:#0a1a0a;">${asp}</span>`;
                    html += `<span class="aspect-dest" title="${data.dest}">`;
                    html += `<span class="clickable-hash" onclick="showAspectModal('${id.hash}', '${asp}', '${data.dest}')">${destShort}</span>`;
                    html += `</span>`;
                    if (aspData) {
                        html += `<span style="color:#88ff88; font-size:10px;">üìã ${aspData.slice(0,25)}</span>`;
                    }
                    html += `</div>`;
                    html += `<div style="display: flex; gap: 10px;">`;
                    html += `<span style="color:var(--fg);">${data.count} ann.</span>`;
                    html += `<span class="rate" title="frequenza">${aspRateFormatted}</span>`;
                    html += `<span class="period" title="periodo">${aspPeriodFormatted}</span>`;
                    html += `</div>`;
                    html += `</div>`;
                });
                
                html += `</div></div>`;
            });
            
            container.innerHTML = html || '<div style="color:var(--dim); text-align:center; padding:40px;">nessuna identit√†</div>';
        }

        function toggleIdentity(identityHash, element) {
            if (state.expandedIdentities.has(identityHash)) {
                state.expandedIdentities.delete(identityHash);
                element.classList.remove('expanded');
                element.nextElementSibling.classList.remove('expanded');
            } else {
                state.expandedIdentities.add(identityHash);
                element.classList.add('expanded');
                element.nextElementSibling.classList.add('expanded');
            }
        }

        // ============================================
        // === STATISTICHE ===
        // ============================================

        function renderStats() {
            const now = Date.now() / 1000;
            let totalAnnounces = 0;
            let firstSeen = now;
            let lastSeen = 0;
            let activeIdentities = 0;
            
            state.identities.forEach(id => {
                totalAnnounces += id.count;
                firstSeen = Math.min(firstSeen, id.first);
                lastSeen = Math.max(lastSeen, id.last);
                if (isActive(id.last)) activeIdentities++;
            });
            
            const elapsedTotal = lastSeen - firstSeen;
            const globalRateHz = elapsedTotal > 0 ? state.backendStats.total / elapsedTotal : 0;
            const globalPeriod = globalRateHz > 0 ? 1 / globalRateHz : 0;
            
            document.getElementById('stat-total').textContent = state.backendStats.total;
            document.getElementById('stat-identities').textContent = `${state.identities.size} (${activeIdentities} attive)`;
            document.getElementById('stat-rate').textContent = formatRate(globalRateHz);
            document.getElementById('stat-period').textContent = formatPeriod(globalPeriod);
            
            const aspectCount = new Map();
            state.identities.forEach(id => {
                id.aspects.forEach((data, asp) => {
                    if (ASPECTS.includes(asp)) {
                        aspectCount.set(asp, (aspectCount.get(asp) || 0) + data.count);
                    }
                });
            });
            
            let aspHtml = '';
            [...aspectCount.entries()].sort((a,b) => b[1] - a[1]).slice(0, 8).forEach(([asp, cnt]) => {
                aspHtml += `<div class="stat-card"><div style="display:flex; justify-content:space-between;">`;
                aspHtml += `<span style="color:var(--fg);">${asp.slice(0,12)} </span>`;
                aspHtml += `<span style="color:var(--dim);"> ${cnt} ann.</span>`;
                aspHtml += `</div></div>`;
            });
            document.getElementById('stats-aspects').innerHTML = aspHtml || '<div style="color:var(--dim);">nessun dato</div>';
            
            let idHtml = '';
            [...state.identities.values()]
                .sort((a,b) => b.count - a.count)
                .slice(0, 10)
                .forEach(id => {
                    const active = isActive(id.last);
                    const elapsed = id.last - id.first;
                    const idRateHz = elapsed > 0 && id.count > 1 ? id.count / elapsed : 0;
                    const idPeriod = idRateHz > 0 ? 1 / idRateHz : 0;
                    const lastData = decodeUTF8(id.lastData);
                    const lastActiveAgo = Math.round((now - id.last) / 60);
                    
                    idHtml += `<div class="stat-card">`;
                    idHtml += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">`;
                    idHtml += `<span style="font-family:monospace; color:#8888ff;" title="${id.hash}">${id.hash.slice(0,16)}‚Ä¶</span>`;
                    if (lastData) idHtml += `<span style="color:#88ff88; font-size:9px;">${lastData.slice(0,16)}</span>`;
                    idHtml += `</div>`;
                    idHtml += `<div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px;">`;
                    idHtml += `<span style="color:var(--dim);">${id.count} ann.</span>`;
                    if (active) {
                        idHtml += `<span style="color:#ffff88;" title="frequenza: ${formatRate(idRateHz)}">‚ö° ${formatRate(idRateHz)}</span>`;
                        idHtml += `<span style="color:#88ffff;" title="periodo: ogni ${formatPeriod(idPeriod)}">‚è±Ô∏è ${formatPeriod(idPeriod)}</span>`;
                    } else {
                        idHtml += `<span class="inactive">üí§ ${lastActiveAgo} min</span>`;
                    }
                    idHtml += `</div>`;
                    idHtml += `<div style="display:flex; justify-content:space-between; margin-top:4px; font-size:9px; color:var(--dim);">`;
                    idHtml += `<span>${id.aspects.size} aspect</span>`;
                    idHtml += `<span>${Math.round(elapsed)}s di vita</span>`;
                    idHtml += `</div>`;
                    idHtml += `</div>`;
                });
            document.getElementById('stats-identities').innerHTML = idHtml || '<div style="color:var(--dim);">nessun dato</div>';
        }

        // ============================================
        // === PAGINAZIONE ===
        // ============================================

        function updatePagination(total) {
            const pages = Math.ceil(total / state.limit) || 1;
            const start = (state.page - 1) * state.limit + 1;
            const end = Math.min(state.page * state.limit, total);
            
            document.getElementById('total-items').textContent = total;
            document.getElementById('showing-start').textContent = total ? start : 0;
            document.getElementById('showing-end').textContent = total ? end : 0;
            document.getElementById('page-info').textContent = `pagina ${state.page}/${pages}`;
            
            document.getElementById('prev-page').disabled = state.page <= 1;
            document.getElementById('next-page').disabled = state.page >= pages;
        }

        // ============================================
        // === LOAD HISTORY - CARICA TUTTI GLI ANNUNCI ===
        // ============================================

        function loadHistory() {
            const params = new URLSearchParams({
                aspect: 'all',  // Prende tutti gli aspect
                search: '',
                limit: 1000,    // Prende fino a 1000 annunci
                offset: 0,
                sort: 'time_desc',
                source: state.cacheSource
            });

            fetch(`/api/monitor/history?${params}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // Salva TUTTI gli annunci nell'array globale
                        window._allAnnounces = data.announces || [];
                        
                        console.log(`üìä Caricati ${window._allAnnounces.length} annunci da ${state.cacheSource}`);
                        
                        // Applica l'ordinamento corrente e renderizza
                        applyCurrentSortAndRender();
                        
                        // Aggiorna i tab
                        if (window.updateAspectTabs) {
                            window.updateAspectTabs();
                        }
                    }
                })
                .catch(err => console.error('History error:', err));
        }

        // ============================================
        // === CONNESSIONE SSE ===
        // ============================================

        function connectSSE() {
            if (state.eventSource && state.eventSource.readyState === EventSource.OPEN) {
                console.log('SSE gi√† connesso, salto...');
                return;
            }
            
            if (state.eventSource) {
                console.log('Chiusura vecchia connessione SSE...');
                state.eventSource.close();
                state.eventSource = null;
            }
            
            if (state.connecting) {
                console.log('Connessione gi√† in corso...');
                return;
            }
            
            state.connecting = true;
            
            setTimeout(() => {
                try {
                    console.log('Tentativo connessione SSE...');
                    const es = new EventSource('/api/monitor/stream');
                    
                    const connectionTimeout = setTimeout(() => {
                        if (es.readyState !== EventSource.OPEN) {
                            console.log('Timeout connessione SSE');
                            es.close();
                            if (state.eventSource === es) {
                                state.eventSource = null;
                            }
                            state.connecting = false;
                            setTimeout(connectSSE, 3000);
                        }
                    }, 5000);
                    
                    es.onopen = () => {
                        clearTimeout(connectionTimeout);
                        console.log('‚úÖ SSE connesso');
                        document.getElementById('status').className = 'status online';
                        state.eventSource = es;
                        state.connecting = false;
                        state.reconnectAttempt = 1;
                        refreshBackendStats();
                    };
                    
                    es.onmessage = (e) => {
                        if (e.data && e.data !== ':') {
                            try {
                                const ann = JSON.parse(e.data);
                                if (ann.id > state.lastId) {
                                    state.lastId = ann.id;
                                    refreshBackendStats();
                                    
                                    // AGGIUNGI IL NUOVO ANNUNCIO ALL'ARRAY GLOBALE
                                    if (!window._allAnnounces) {
                                        window._allAnnounces = [];
                                    }
                                    
                                    // Aggiungi in testa (pi√π recente)
                                    window._allAnnounces.unshift(ann);
                                    
                                    // Limita la dimensione
                                    if (window._allAnnounces.length > 2000) {
                                        window._allAnnounces.pop();
                                    }
                                    
                                    // AGGIORNA LE STATISTICHE
                                    if (!state.resetting) {
                                        updateIdentityStats(ann);
                                    }
                                    
                                    if (window.updateAspectTabs) window.updateAspectTabs();
                                    
                                    // APPLICA L'ORDINAMENTO CORRENTE E RENDERIZZA
                                    if (state.view === 'live' && state.cacheSource === 'memory') {
                                        applyCurrentSortAndRender();
                                    }
                                    
                                    if (state.view === 'identities') renderIdentities();
                                    if (state.view === 'stats') renderStats();
                                }
                            } catch(e) {
                                console.error('SSE parse error:', e);
                            }
                        }
                    };
                    
                    es.onerror = (err) => {
                        clearTimeout(connectionTimeout);
                        console.error('SSE errore:', err);
                        document.getElementById('status').className = 'status offline';
                        
                        if (state.eventSource === es) {
                            state.eventSource = null;
                        }
                        
                        state.connecting = false;
                        
                        const delay = Math.min(3000 * (state.reconnectAttempt || 1), 30000);
                        state.reconnectAttempt = (state.reconnectAttempt || 1) + 1;
                        
                        setTimeout(() => {
                            if (!state.eventSource && !state.resetting) {
                                connectSSE();
                            }
                        }, delay);
                    };
                    
                } catch (e) {
                    console.error('Errore creazione SSE:', e);
                    state.connecting = false;
                    setTimeout(connectSSE, 5000);
                }
            }, 100);
        }

        // ============================================
        // === FUNZIONE CHE FORZA I TAB A ZERO ===
        // ============================================

        function forceTabsToZero() {
            console.log('üî® FORZATURA TAB A ZERO');
            
            const row1 = document.getElementById('aspect-row-1');
            const row2 = document.getElementById('aspect-row-2');
            const row3 = document.getElementById('aspect-row-3');
            
            if (!row1 || !row2 || !row3) {
                console.log('‚ùå Righe tab non trovate');
                return;
            }
            
            let html1 = `<div class="tab-aspect ${state.aspect === 'all' ? 'active' : ''}" data-aspect="all">üìã tutti (0)</div>`;
            ASPECTS.slice(0, 10).forEach(a => {
                const short = a.split('.').pop();
                html1 += `<div class="tab-aspect ${state.aspect === a ? 'active' : ''}" data-aspect="${a}">${short} (0)</div>`;
            });
            row1.innerHTML = html1;
            
            let html2 = ``;
            ASPECTS.slice(10, 20).forEach(a => {
                const short = a.split('.').pop();
                html2 += `<div class="tab-aspect ${state.aspect === a ? 'active' : ''}" data-aspect="${a}">${short} (0)</div>`;
            });
            row2.innerHTML = html2;
            
            let html3 = ``;
            ASPECTS.slice(20).forEach(a => {
                const short = a.split('.').pop();
                html3 += `<div class="tab-aspect ${state.aspect === a ? 'active' : ''}" data-aspect="${a}">${short} (0)</div>`;
            });
            html3 += `<div class="tab-aspect ${state.aspect === 'known' ? 'active' : ''}" data-aspect="known">‚úì conosciuti (0)</div>`;
            html3 += `<div class="tab-aspect ${state.aspect === 'unknown' ? 'active' : ''}" data-aspect="unknown">? sconosciuti (0)</div>`;
            row3.innerHTML = html3;
            
            document.querySelectorAll('.tab-aspect').forEach(tab => {
                const newTab = tab.cloneNode(true);
                tab.parentNode.replaceChild(newTab, tab);
                
                newTab.addEventListener('click', function(e) {
                    document.querySelectorAll('.tab-aspect').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    state.aspect = this.dataset.aspect;
                    state.page = 1;
                    loadHistory();
                });
            });
            
            console.log('‚úÖ Tab forzati a zero');
        }

        // ============================================
        // === RESET TOTALE ===
        // ============================================

        function resetAll() {
            if (confirm('üí• RESET TOTALE: cancellare TUTTI i dati (cache, storico, identit√†)?')) {
                state.resetting = true;
                state.reconnectAttempt = 1;
                
                document.getElementById('announce-body').innerHTML = '<tr><td colspan="10" style="text-align:center; padding:40px; color:#ffff88;">üîÑ RESET IN CORSO...</td></tr>';
                
                if (state.eventSource) {
                    state.eventSource.close();
                    state.eventSource = null;
                }
                
                const resetBtn = document.getElementById('reset-all-btn');
                resetBtn.disabled = true;
                resetBtn.style.opacity = '0.5';
                
                console.log('üßπ Pulizia frontend...');
                
                state.identities.clear();
                state.expandedIdentities.clear();
                state.lastId = 0;
                state.backendStats = { total: 0, unique: 0, cacheSize: 0 };
                state.aspect = 'all';
                state.page = 1;
                state.search = '';
                
                // Pulisci array globale
                window._allAnnounces = [];
                
                console.log('üóëÔ∏è Pulizia localStorage...');
                localStorage.clear();
                localStorage.removeItem(STORAGE_KEY);
                
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({
                        timestamp: Date.now(),
                        identities: []
                    }));
                } catch(e) {
                    console.log('Errore sovrascrittura:', e);
                }

                resetProcessedAnnounces();

                document.getElementById('total-announces').textContent = '0';
                document.getElementById('unique-sources').textContent = '0';
                document.getElementById('cache-size-indicator').textContent = '0';
                
                document.getElementById('stat-total').textContent = '0';
                document.getElementById('stat-identities').textContent = '0 (0 attive)';
                document.getElementById('stat-rate').textContent = '‚Äî';
                document.getElementById('stat-period').textContent = '‚Äî';
                
                document.getElementById('announce-body').innerHTML = 
                    '<tr><td colspan="10" style="text-align:center; padding:40px; color:var(--dim);">‚Äî nessun annuncio ‚Äî</td></tr>';
                
                document.getElementById('identity-container').innerHTML = 
                    '<div style="color:var(--dim); text-align:center; padding:40px;">nessuna identit√†</div>';
                
                document.getElementById('stats-aspects').innerHTML = '';
                document.getElementById('stats-identities').innerHTML = '';
                
                console.log('üîÑ Forzatura tab a zero...');
                forceTabsToZero();
                
                console.log('üì° Chiamata backend reset-all...');
                fetch('/api/monitor/reset-all', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Reset completato:', data);
                    
                    if (data.success) {
                        loadHistory();
                        
                        setTimeout(() => {
                            connectSSE();
                        }, 500);
                        
                        alert('‚úÖ RESET COMPLETO');
                    } else {
                        alert('‚ùå Errore: ' + (data.error || 'Sconosciuto'));
                    }
                })
                .catch(error => {
                    console.error('Errore reset:', error);
                    alert('‚ùå Errore di connessione: ' + error.message);
                    
                    setTimeout(() => {
                        connectSSE();
                    }, 1000);
                })
                .finally(() => {
                    state.resetting = false;
                    resetBtn.disabled = false;
                    resetBtn.style.opacity = '1';
                });
            }
        }

        // ============================================
        // === RESET PROCESSED ANNOUNCES ===
        // ============================================

        function resetProcessedAnnounces() {
            window._processedAnnounces = new Set();
            console.log('üßπ Set annunci processati resettato');
        }

        // ============================================
        // === EVENT LISTENERS ===
        // ============================================

        function initEventListeners() {
            document.getElementById('limit-select').addEventListener('change', function() {
                state.limit = parseInt(this.value);
                state.page = 1;
                applyCurrentSortAndRender();
            });

            document.getElementById('search-input').addEventListener('input', function() {
                state.search = this.value.toLowerCase();
                state.page = 1;
                applyCurrentSortAndRender();
            });

            document.getElementById('identity-search-input').addEventListener('input', function() {
                renderIdentities();
            });

            document.getElementById('cache-source-select').addEventListener('change', function() {
                state.cacheSource = this.value;
                state.page = 1;
                
                if (state.cacheSource === 'cache') {
                    loadHistory();
                } else {
                    if (window.updateAspectTabs) {
                        window.updateAspectTabs();
                    }
                    applyCurrentSortAndRender();
                }
            });

            document.getElementById('reset-all-btn').addEventListener('click', resetAll);

            document.getElementById('prev-page').addEventListener('click', function() {
                if (state.page > 1) { 
                    state.page--; 
                    applyCurrentSortAndRender();
                }
            });

            document.getElementById('next-page').addEventListener('click', function() {
                state.page++; 
                applyCurrentSortAndRender();
            });

            document.getElementById('identity-sort-select').addEventListener('change', function() {
                renderIdentities();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modalState.visible) {
                    hideAspectModal();
                }
            });
        }

        // ============================================
        // === INIZIALIZZAZIONE ===
        // ============================================

        if (!window._rnsMonitorInitialized) {
            window._rnsMonitorInitialized = true;
            
            window.addEventListener('beforeunload', function() {
                if (state.eventSource) {
                    state.eventSource.close();
                    state.eventSource = null;
                }
                saveIdentitiesToStorage();
            });

            loadIdentitiesFromStorage();
            initAspectTabs();
            initMainTabs();
            initEventListeners();
            connectSSE();
            loadHistory();
            refreshBackendStats();
            updateSortIndicators();
            
            setInterval(saveIdentitiesToStorage, 30000);
            setInterval(() => {
                if (state.view === 'identities') renderIdentities();
                if (state.view === 'stats') renderStats();
                if (state.view === 'live') {
                    // Non serve pi√π sortTableByState perch√© usiamo applyCurrentSortAndRender
                }
                refreshBackendStats();
            }, 2000);
        } else {
            console.log('Inizializzazione gi√† eseguita, salto...');
        }
    </script>
</body>
</html>